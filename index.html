<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Cosmo Arcade ‚Äî Worm + Cat + Bots + Camera</title>
<style>
  html,body{margin:0;height:100%;background:#0a1020;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;-webkit-user-select:none;user-select:none;touch-action:none}
  #wrap{display:flex;flex-direction:column;height:100dvh}
  header{padding:8px 12px;background:#121a36;border-bottom:1px solid #22325a;display:flex;gap:8px;align-items:center}
  header h1{font-size:16px;margin:0}
  #ui{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .hbtn{padding:6px 10px;background:#182a56;border:1px solid #3a5aa0;border-radius:8px;color:#fff;font-weight:700;cursor:pointer}
  #score{padding:6px 10px;background:#0f1a36;border:1px solid #2b3f6f;border-radius:8px;font-weight:700;min-width:64px;text-align:center}

  #stage{position:relative;flex:1;min-height:0}
  #canvas{position:absolute;inset:0;display:block;width:100%;height:100%;touch-action:none;background:#070c18;z-index:1}

  /* –û–≤–µ—Ä–ª–µ–∏ */
  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(8,12,24,.85);z-index:20}
  .card{background:#0f1730;border:1px solid #2b3f6f;border-radius:12px;padding:16px;max-width:600px;width:92%}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .btn{display:inline-block;padding:12px 14px;background:#182a56;border:1px solid #3a5aa0;border-radius:10px;color:#fff;font-weight:700;cursor:pointer}
  .field{display:flex;gap:8px;align-items:center;margin:6px 0}
  input[type="text"],input[type="number"]{background:#0f1a36;color:#fff;border:1px solid #2b3f6f;border-radius:8px;padding:8px 10px;min-width:160px}

  /* –ü–ª–∞–≤–∞—é—â–∏–π –¥–∂–æ–π—Å—Ç–∏–∫ */
  #joy{position:absolute;left:0;top:0;width:0;height:0;pointer-events:none;z-index:5;display:none}
  .joy-base{position:absolute;width:120px;height:120px;margin-left:-60px;margin-top:-60px;border-radius:50%;background:#0b1430cc;border:1px solid #2b3e68}
  .joy-knob{position:absolute;left:0;top:0;width:56px;height:56px;margin-left:-28px;margin-top:-28px;border-radius:50%;background:#172a58;border:1px solid #3b5ca0}

  /* –ö–Ω–æ–ø–∫–∏ Worm */
  #boostBtn,#invisBtn{position:absolute;left:14px;bottom:18px;display:none;z-index:6}
  #boostBtn{transform:translateX(130px);background:#0e8a6a;border-color:#33c49f}
  #invisBtn{transform:translateX(260px);background:#8a0e6a;border-color:#d658b1}

  /* Cat jump */
  #jumpBtn{position:absolute;right:12px;bottom:130px;padding:14px 18px;font-size:18px;font-weight:800;color:#fff;background:#1c2f5e;border:1px solid #3b5ca0;border-radius:12px;display:none;z-index:6}

  /* –í–∏–¥–µ–æ-—Ä–µ–∫–ª–∞–º–∞ */
  #adWrap{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.75);z-index:30}
  #adCard{background:#0b1024;border:1px solid #2b3f6f;border-radius:12px;padding:10px;max-width:80%;width:560px}
  #adVideo{width:100%;max-height:70dvh;background:#000;border-radius:8px}
  #skipAd{margin-top:8px;width:100%}

  /* –ü–æ–¥–ø–∏—Å—å */
  #footer{position:absolute;left:0;right:0;bottom:2px;text-align:center;font-size:12px;opacity:.8;z-index:2;pointer-events:none}
</style>
</head>
<body>
<div id="wrap">
  <header>
    <h1>Cosmo Arcade</h1>
    <div id="ui">
      <div id="score">0</div>
      <button id="menuBtn" class="hbtn">–í –º–µ–Ω—é</button>
      <button id="switchBtn" class="hbtn">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∏–≥—Ä—É</button>
      <button id="shopBtn" class="hbtn">–ú–∞–≥–∞–∑–∏–Ω</button>
      <button id="recordsBtn" class="hbtn">–†–µ–∫–æ—Ä–¥—ã</button>
    </div>
  </header>

  <div id="stage">
    <canvas id="canvas"></canvas>

    <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
    <div id="mainMenu" class="overlay" style="display:flex">
      <div class="card">
        <h3 style="margin:0 0 8px 0">–í—ã–±–∏—Ä–∞–π —Ä–µ–∂–∏–º</h3>
        <div class="row">
          <button class="btn" data-mode="worm">üêç Worm</button>
          <button class="btn" data-mode="cat">üê± Cat</button>
        </div>
        <p style="opacity:.85;font-size:12px;margin-top:8px">Worm: –ø–ª–∞–≤–∞—é—â–∏–π –¥–∂–æ–π—Å—Ç–∏–∫ –ø–æ–¥ –ø–∞–ª—å—Ü–µ–º, —É—Å–∫–æ—Ä–µ–Ω–∏–µ, —Ñ—Ä—É–∫—Ç—ã, –±–æ–º–±—ã, –±–æ—Ç—ã, –∫–∞–º–µ—Ä–∞ –ø–æ –∫–∞—Ä—Ç–µ. Cat: –¥–∂–æ–π—Å—Ç–∏–∫ + –∫–Ω–æ–ø–∫–∞ –ø—Ä—ã–∂–∫–∞, –∫–∞–º–µ—Ä–∞ –≤–≤–µ—Ä—Ö.</p>
      </div>
    </div>

    <!-- –°–¢–ê–†–¢-–ù–ê–°–¢–†–û–ô–ö–ê –ü–ï–†–ï–î –ò–ì–†–û–ô -->
    <div id="preStart" class="overlay">
      <div class="card">
        <h3 style="margin:0 0 10px 0">–°—Ç–∞—Ä—Ç –∏–≥—Ä—ã</h3>
        <div class="field">
          <label for="playerName">–ò–º—è –∑–º–µ–π–∫–∏:</label>
          <input id="playerName" type="text" placeholder="–≤–∞—à–µ –∏–º—è" maxlength="16">
        </div>
        <div id="wormOpts">
          <div class="field">
            <label for="botCount">–ë–æ—Ç–æ–≤ (–ø–ª–∞–Ω–µ—Ç—ã):</label>
            <input id="botCount" type="number" min="0" max="12" value="6" style="width:90px">
          </div>
          <div class="field">
            <button id="preInvis" class="btn">–í–∫–ª—é—á–∏—Ç—å ¬´–ù–µ–≤–∏–¥–∏–º–∫–∞¬ª –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (–µ—Å–ª–∏ –∫—É–ø–ª–µ–Ω–∞)</button>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="startPlay" class="btn">–ò–≥—Ä–∞—Ç—å</button>
          <button id="preCancel" class="btn">–ù–∞–∑–∞–¥</button>
        </div>
      </div>
    </div>

    <!-- –ú–ê–ì–ê–ó–ò–ù -->
    <div id="shop" class="overlay">
      <div class="card">
        <h3 style="margin:0 0 8px 0">–ú–∞–≥–∞–∑–∏–Ω –±—É—Å—Ç–æ–≤</h3>
        <p id="bank" style="margin:4px 0 10px 0">–ë–∞–ª–∞–Ω—Å: 0 –æ—á–∫–æ–≤</p>
        <div class="row">
          <button class="btn" id="buyInvis">–ö—É–ø–∏—Ç—å ¬´–ù–µ–≤–∏–¥–∏–º–∫–∞¬ª (200)</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="shopClose">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <p style="opacity:.75;font-size:12px;margin-top:8px">¬´–ù–µ–≤–∏–¥–∏–º–∫–∞¬ª: –ø—Ä–æ—Ö–æ–¥ —á–µ—Ä–µ–∑ –±–æ–º–±—ã/–ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è ~10 —Å–µ–∫.</p>
      </div>
    </div>

    <!-- –†–ï–ö–û–†–î–´ -->
    <div id="records" class="overlay">
      <div class="card">
        <h3 style="margin:0 0 8px 0">–¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤</h3>
        <div id="recAll" style="font-family:monospace;white-space:pre"></div>
        <h4 style="margin:10px 0 4px 0">–í–∞—à–∏ –ª—É—á—à–∏–µ</h4>
        <div id="recMine" style="font-family:monospace;white-space:pre"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="recClose">–ó–∞–∫—Ä—ã—Ç—å</button>
          <button class="btn" id="recReset">–°–±—Ä–æ—Å–∏—Ç—å —Ä–µ–∫–æ—Ä–¥—ã</button>
        </div>
      </div>
    </div>

    <!-- –†–ï–ö–õ–ê–ú–ö–ê (–≤–∏–¥–µ–æ) -->
    <div id="adWrap" class="overlay">
      <div id="adCard">
        <video id="adVideo" playsinline muted autoplay controls></video>
        <button class="btn" id="skipAd">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
      </div>
    </div>

    <!-- –ü–ª–∞–≤–∞—é—â–∏–π –¥–∂–æ–π—Å—Ç–∏–∫ -->
    <div id="joy">
      <div class="joy-base"></div>
      <div class="joy-knob"></div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ –∏–≥—Ä—ã -->
    <button id="boostBtn" class="btn">Boost</button>
    <button id="invisBtn" class="btn">–ù–µ–≤–∏–¥–∏–º–∫–∞</button>
    <button id="jumpBtn" class="btn" aria-label="jump">‚§¥Ô∏é Jump</button>

    <div id="footer">made by kosmos.bud 2k25</div>
  </div>
</div>

<script>
/* ======== –£–¢–ò–õ–ò–¢–´/–•–†–ê–ù–ï–ù–ò–ï ======== */
var LS={get:function(k,d){try{var v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(e){return d}},set:function(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}}};
var playerName = LS.get('playerName','Player');
var bank = LS.get('bank',0);
var invCount = LS.get('invCount',0);

/* ======== DOM ======== */
var canvas=document.getElementById('canvas'), ctx=canvas.getContext('2d');
var mainMenu=document.getElementById('mainMenu'), preStart=document.getElementById('preStart');
var wormOpts=document.getElementById('wormOpts'), startPlay=document.getElementById('startPlay'), preCancel=document.getElementById('preCancel');
var nameInput=document.getElementById('playerName'), botCountInput=document.getElementById('botCount'), preInvisBtn=document.getElementById('preInvis');
var shop=document.getElementById('shop'), bankEl=document.getElementById('bank'), buyInvisBtn=document.getElementById('buyInvis'), shopClose=document.getElementById('shopClose');
var records=document.getElementById('records'), recAll=document.getElementById('recAll'), recMine=document.getElementById('recMine'), recClose=document.getElementById('recClose'), recReset=document.getElementById('recReset');
var menuBtn=document.getElementById('menuBtn'), switchBtn=document.getElementById('switchBtn'), shopBtn=document.getElementById('shopBtn'), recordsBtn=document.getElementById('recordsBtn');
var scoreEl=document.getElementById('score');
var adWrap=document.getElementById('adWrap'), adVideo=document.getElementById('adVideo'), skipAd=document.getElementById('skipAd');

var joyWrap=document.getElementById('joy'), joyBase=joyWrap.querySelector('.joy-base'), joyKnob=joyWrap.querySelector('.joy-knob');
var boostBtn=document.getElementById('boostBtn'), invisBtn=document.getElementById('invisBtn'), jumpBtn=document.getElementById('jumpBtn');

/* ======== –ö–ê–ù–í–ê–° ======== */
function resize(){var r=Math.max(1,Math.min(window.devicePixelRatio||1,3)),w=canvas.parentElement.clientWidth,h=canvas.parentElement.clientHeight;canvas.style.width=w+'px';canvas.style.height=h+'px';canvas.width=Math.floor(w*r);canvas.height=Math.floor(h*r);ctx.setTransform(r,0,0,r,0,0);}
addEventListener('resize',resize);resize();

/* ======== –û–ë–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï ======== */
var mode='menu', score=0;
function setScore(v){score=v|0;scoreEl.textContent=score;}
function showMain(){mode='menu';mainMenu.style.display='flex';hide(preStart);showControls('none');}
function hide(el){ if(el) el.style.display='none'; }
function show(el){ if(el) el.style.display='flex'; }

/* –∫–Ω–æ–ø–∫–∏ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ */
menuBtn.onclick = showMain;
switchBtn.onclick=function(){ if(mode==='worm'){ startCat(); } else if(mode==='cat'){ openPreStart('worm'); } };
shopBtn.onclick=function(){updateBankUI();show(shop);}
recordsBtn.onclick=function(){updateRecordsUI();show(records);}
shopClose.onclick=function(){hide(shop);}
recClose.onclick=function(){hide(records);}
recReset.onclick=function(){ if(confirm('–°–±—Ä–æ—Å–∏—Ç—å —Ä–µ–∫–æ—Ä–¥—ã?')){ LS.set('records',[]); updateRecordsUI(); } };

document.querySelectorAll('[data-mode]').forEach(function(b){ b.onclick=function(){ openPreStart(b.getAttribute('data-mode')); }; });

/* ======== –ü–†–ï–°–¢–ê–†–¢-–û–ö–ù–û ======== */
var preTarget='worm', preInvis=false;
function openPreStart(target){
  preTarget=target||'worm';
  nameInput.value = playerName || 'Player';
  wormOpts.style.display = preTarget==='worm' ? '' : 'none';
  hide(mainMenu); show(preStart);
}
preCancel.onclick=function(){ hide(preStart); showMain(); };
preInvisBtn.onclick=function(){
  if(invCount>0){ preInvis=!preInvis; alert('–ù–µ–≤–∏–¥–∏–º–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ: '+(preInvis?'–í–ö–õ':'–í–´–ö–õ')); }
  else alert('–£ –≤–∞—Å –Ω–µ—Ç –∫—É–ø–ª–µ–Ω–Ω–æ–π –Ω–µ–≤–∏–¥–∏–º–∫–∏. –ö—É–ø–∏—Ç–µ –≤ –º–∞–≥–∞–∑–∏–Ω–µ.');
};
startPlay.onclick=function(){
  playerName=(nameInput.value||'Player').slice(0,16); LS.set('playerName',playerName);
  hide(preStart);
  if (preTarget==='worm'){ startWorm(parseInt(botCountInput.value,10)||0); }
  else { startCat(); }
};

/* ======== –ú–ê–ì–ê–ó–ò–ù/–†–ï–ö–û–†–î–´ ======== */
function updateBankUI(){ bankEl.textContent='–ë–∞–ª–∞–Ω—Å: '+bank+' –æ—á–∫–æ–≤'; }
buyInvisBtn.onclick=function(){ if(bank>=200){ bank-=200; invCount++; LS.set('bank',bank); LS.set('invCount',invCount); updateBankUI(); alert('–ù–µ–≤–∏–¥–∏–º–∫–∞ –∫—É–ø–ª–µ–Ω–∞'); } else alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤'); };
function fmtTable(a){var s='';for(var i=0;i<a.length;i++){var r=a[i];s+=(i+1)+'. '+(r.name||'Player')+' ‚Äî '+r.score+'\n';}return s||'(–ø—É—Å—Ç–æ)';}
function updateRecordsUI(){ var all=LS.get('records',[]).sort(function(a,b){return b.score-a.score}); recAll.textContent=fmtTable(all.slice(0,10)); var mine=all.filter(function(r){return r.name===playerName}).sort(function(a,b){return b.score-a.score}); recMine.textContent=fmtTable(mine.slice(0,10)); }
function saveRecord(name,sc){ var arr=LS.get('records',[]); arr.push({name:name||'Player',score:sc|0,ts:Date.now()}); LS.set('records',arr); }

/* ======== –ü–õ–ê–í–ê–Æ–©–ò–ô –î–ñ–û–ô–°–¢–ò–ö (–∫–∞–∫ wormax-—Å—Ç–∞–π–ª) ======== */
var joy={active:false, ox:0, oy:0, ax:0, ay:0}; // origin & axes (-1..1)
function showJoy(x,y){ joyWrap.style.display='block'; joyWrap.style.transform='translate('+x+'px,'+y+'px)'; joyBase.style.transform='translate(0,0)'; joyKnob.style.transform='translate(0,0)'; }
function moveJoy(x,y){
  var dx=x-joy.ox, dy=y-joy.oy, len=Math.sqrt(dx*dx+dy*dy)||1, maxR=50;
  var nx=dx/len, ny=dy/len, r=Math.min(len,maxR);
  joy.ax = (dx===0 && dy===0)?0:(dx/Math.max(len,1));
  joy.ay = (dx===0 && dy===0)?0:(dy/Math.max(len,1));
  joyKnob.style.transform='translate('+ (nx*r) +'px,'+ (ny*r) +'px)';
}
function hideJoy(){ joyWrap.style.display='none'; joy.active=false; joy.ax=joy.ay=0; }

canvas.addEventListener('pointerdown', function(e){
  if(mode!=='worm' && mode!=='cat') return;
  e.preventDefault();
  joy.active=true; joy.ox=e.clientX; joy.oy=e.clientY; showJoy(joy.ox, joy.oy);
  moveJoy(e.clientX,e.clientY);
},{passive:false});
canvas.addEventListener('pointermove', function(e){ if(!joy.active) return; moveJoy(e.clientX,e.clientY); });
canvas.addEventListener('pointerup', function(){ hideJoy(); });
canvas.addEventListener('pointercancel', function(){ hideJoy(); });

/* ======== WORM ‚Äî –ö–ê–ú–ï–†–ê, –ë–û–¢–´, –ú–ò–† ======== */
var world={w:3200,h:2000};
var cam={x:0,y:0};
var worm=null, foods=[], bombs=[], bots=[];
var boostHold=false, boostMul=1.6;
var invis=false, invisTimer=0;

var FRUITS=[ {c:'#ff6b6b',p:5}, {c:'#ffd166',p:7}, {c:'#c084fc',p:9}, {c:'#7dd3fc',p:12} ];
var PLANETS=['–ó–µ–º–ª—è','–ú–∞—Ä—Å','–Æ–ø–∏—Ç–µ—Ä','–í–µ–Ω–µ—Ä–∞','–°–∞—Ç—É—Ä–Ω','–£—Ä–∞–Ω','–ù–µ–ø—Ç—É–Ω','–ú–µ—Ä–∫—É—Ä–∏–π','–ü–ª—É—Ç–æ–Ω','–ò–æ','–ï–≤—Ä–æ–ø–∞','–¢–∏—Ç–∞–Ω'];

function startWorm(botN){
  mode='worm'; setScore(0);
  foods=[]; bombs=[]; bots=[];
  // –∏–≥—Ä–æ–∫
  worm=makeSnake(playerName, world.w*0.5, world.h*0.5, true);
  // –µ–¥–∞/–±–æ–º–±—ã
  var dens = Math.round((world.w*world.h)/35000);
  for(var i=0;i<dens;i++) spawnFruit();
  for(i=0;i<Math.ceil(dens/6);i++) spawnBomb();
  // –±–æ—Ç—ã
  botN = Math.max(0, Math.min(botN|0, PLANETS.length));
  for(i=0;i<botN;i++){
    var x=Math.random()*world.w, y=Math.random()*world.h, nm=PLANETS[i%PLANETS.length];
    bots.push(makeSnake(nm,x,y,false));
  }
  // –∫–∞–º–µ—Ä–∞ –∫ –∏–≥—Ä–æ–∫—É
  centerCameraOn(worm);
  // –ø—Ä–µ–¥-–Ω–µ–≤–∏–¥–∏–º–∫–∞
  if(preInvis && invCount>0){ invCount--; LS.set('invCount',invCount); invis=true; invisTimer=10; }
  showControls('worm');
}
function makeSnake(name,x,y,isPlayer){
  return {name:name||'Player', x:x,y:y, ang:Math.random()*Math.PI*2, spd:140, trail:[], segs:16, step:4, alive:true, ai:!isPlayer, aiTurn:0, color:isPlayer?'player':'bot'};
}
function spawnFruit(){ foods.push({x:Math.random()*world.w,y:Math.random()*world.h,r:4,c:FRUITS[(Math.random()*FRUITS.length)|0]}); }
function spawnBomb(){ bombs.push({x:Math.random()*world.w,y:Math.random()*world.h,r:10}); }
function wrapPos(o){ if(o.x<0)o.x+=world.w; if(o.x>world.w)o.x-=world.w; if(o.y<0)o.y+=world.h; if(o.y>world.h)o.y-=world.h; }
function centerCameraOn(o){ var W=canvas.clientWidth,H=canvas.clientHeight; cam.x=o.x - W*0.5; cam.y=o.y - H*0.5; }
function clampCam(){ var W=canvas.clientWidth,H=canvas.clientHeight; cam.x=Math.max(0,Math.min(world.w-W,cam.x)); cam.y=Math.max(0,Math.min(world.h-H,cam.y)); }

function updateWorm(dt){
  // —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
  var ang = worm.ang;
  if (joy.active){ ang = Math.atan2(joy.ay, joy.ax); }
  worm.ang = ang;
  var spd = worm.spd * (boostHold?boostMul:1);
  worm.x += Math.cos(worm.ang)*spd*dt;
  worm.y += Math.sin(worm.ang)*spd*dt;
  wrapPos(worm);
  worm.trail.unshift({x:worm.x,y:worm.y}); if(worm.trail.length>1600) worm.trail.pop();

  // –±–æ—Ç—ã ‚Äî –ø—Ä–æ—Å—Ç–∞—è –ò–ò: —Ç—è–Ω—É—Ç—Å—è –∫ –±–ª–∏–∂–∞–π—à–µ–º—É —Ñ—Ä—É–∫—Ç—É, –∏–∑–±–µ–≥–∞—é—Ç –±–æ–º–±—É, –∏–Ω–æ–≥–¥–∞ —à—É–º—è—Ç
  for(var i=0;i<bots.length;i++){
    var b=bots[i];
    var tgt=getNearest(foods,b.x,b.y);
    var avoid=getNearest(bombs,b.x,b.y);
    var turn = b.ang;
    if (tgt){ var a=Math.atan2(tgt.y-b.y, tgt.x-b.x); turn = mixAngle(b.ang,a,0.08); }
    if (avoid && dist(b.x,b.y,avoid.x,avoid.y)<120){ // –∏–∑–±–µ–≥–∞—Ç—å
      var aa=Math.atan2(b.y-avoid.y, b.x-avoid.x);
      turn = mixAngle(turn, aa, 0.25);
    }
    // –Ω–µ–º–Ω–æ–≥–æ ¬´–∂–∏–≤–æ—Å—Ç–∏¬ª
    b.aiTurn=(b.aiTurn||0) + (Math.random()-0.5)*0.02;
    b.ang = wrapAngle(turn + b.aiTurn);
    var sp= b.spd* (0.95+Math.random()*0.1);
    b.x += Math.cos(b.ang)*sp*dt; b.y += Math.sin(b.ang)*sp*dt; wrapPos(b);
    b.trail.unshift({x:b.x,y:b.y}); if(b.trail.length>1400) b.trail.pop();
    // –µ–¥–∞ –¥–ª—è –±–æ—Ç–∞ (–æ–Ω –µ—Å—Ç, –Ω–æ –æ—á–∫–∏ —Ç–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫—É)
    for(var fi=foods.length-1;fi>=0;fi--){ if(dist(b.x,b.y,foods[fi].x,foods[fi].y)<12){ foods.splice(fi,1); spawnFruit(); } }
  }

  // –µ–¥–∞ –¥–ª—è –∏–≥—Ä–æ–∫–∞
  for(i=foods.length-1;i>=0;i--){
    var f=foods[i];
    if (dist(worm.x,worm.y,f.x,f.y)<12){
      foods.splice(i,1); setScore(score+f.c.p); bank+=f.c.p; spawnFruit();
    }
  }

  // –±–æ–º–±—ã ‚Üí —Ä–µ–∫–ª–∞–º–∫–∞ + —Ä–µ—Å—Ç–∞—Ä—Ç
  for(i=bombs.length-1;i>=0;i--){
    var bb=bombs[i];
    if(!invis && dist(worm.x,worm.y,bb.x,bb.y)<14){
      bombs.splice(i,1);
      triggerAdAndRestart();
      break;
    }
  }

  // —Ç–∞–π–º–µ—Ä –Ω–µ–≤–∏–¥–∏–º–∫–∏
  if(invis){ invisTimer-=dt; if(invisTimer<=0){invis=false;} }

  // –∫–∞–º–µ—Ä–∞ —Ç—è–Ω–µ—Ç—Å—è –∑–∞ –∏–≥—Ä–æ–∫–æ–º
  var W=canvas.clientWidth,H=canvas.clientHeight;
  var targetX=worm.x - W*0.5, targetY=worm.y - H*0.5;
  cam.x += (targetX - cam.x) * Math.min(1, dt*3);
  cam.y += (targetY - cam.y) * Math.min(1, dt*3);
  clampCam();
}
function drawWorm(){
  var W=canvas.clientWidth,H=canvas.clientHeight;
  // —Ñ–æ–Ω-—Å–µ—Ç–∫–∞ –∫–æ—Å–º–æ—Å–∞
  ctx.fillStyle='#081022'; ctx.fillRect(0,0,W,H);
  ctx.strokeStyle='rgba(255,255,255,.06)'; ctx.lineWidth=1;
  var grid=160, x0 = -((cam.x%grid)+grid)%grid; for(var gx=x0; gx<W; gx+=grid){ ctx.beginPath(); ctx.moveTo(gx,0); ctx.lineTo(gx,H); ctx.stroke(); }
  var y0 = -((cam.y%grid)+grid)%grid; for(var gy=y0; gy<H; gy+=grid){ ctx.beginPath(); ctx.moveTo(0,gy); ctx.lineTo(W,gy); ctx.stroke(); }

  // —Ñ—Ä—É–∫—Ç—ã
  for(var i=0;i<foods.length;i++){
    var f=foods[i]; var sx=f.x-cam.x, sy=f.y-cam.y;
    if (sx<-20||sy<-20||sx>W+20||sy>H+20) continue;
    ctx.fillStyle=f.c.c; ctx.beginPath(); ctx.arc(sx,sy,f.r,0,Math.PI*2); ctx.fill();
  }
  // –±–æ–º–±—ã
  for(i=0;i<bombs.length;i++){
    var b=bombs[i]; sx=b.x-cam.x; sy=b.y-cam.y;
    if (sx<-20||sy<-20||sx>W+20||sy>H+20) continue;
    ctx.fillStyle='#111'; ctx.beginPath(); ctx.arc(sx,sy,b.r,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#ff5252'; ctx.beginPath(); ctx.arc(sx,sy,3,0,Math.PI*2); ctx.fill();
  }

  // –±–æ—Ç—ã (—Ñ–∏–æ–ª–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞)
  for(i=0;i<bots.length;i++) drawSnake(bots[i], '#9b8cff', '#e6d5ff');

  // –∏–≥—Ä–æ–∫ (—Ä–∞–¥—É–∂–Ω—ã–π) + –∏–º—è
  drawPlayerSnake(worm);

  // HUD
  ctx.fillStyle='rgba(255,255,255,.85)'; ctx.font='12px system-ui'; ctx.textAlign='left';
  if (boostHold) ctx.fillText('BOOST', 12, 16);
  if (invis)     ctx.fillText('INVIS '+Math.ceil(invisTimer)+'s', 12, 32);
}
function drawSnake(snk, bodyColor, headColor){
  var W=canvas.clientWidth,H=canvas.clientHeight;
  for(var s=0;s<snk.segs;s++){
    var p=snk.trail[s*snk.step]||snk, sx=p.x-cam.x, sy=p.y-cam.y;
    if (sx<-30||sy<-30||sx>W+30||sy>H+30) continue;
    var r=Math.max(3.2, 9.5 - s*0.08);
    ctx.beginPath(); ctx.fillStyle=bodyColor; ctx.arc(sx,sy,r,0,Math.PI*2); ctx.fill();
  }
  // –∏–º—è
  ctx.fillStyle='rgba(255,255,255,.9)'; ctx.font='11px system-ui'; ctx.textAlign='center';
  ctx.fillText(snk.name, snk.x-cam.x, snk.y-cam.y - 16);
}
function drawPlayerSnake(snk){
  var W=canvas.clientWidth,H=canvas.clientHeight;
  for(var s=0;s<snk.segs;s++){
    var p=snk.trail[s*snk.step]||snk, sx=p.x-cam.x, sy=p.y-cam.y;
    if (sx<-30||sy<-30||sx>W+30||sy>H+30) continue;
    var r=Math.max(3.2, 9.8 - s*0.09);
    var hue=(s*14+(Date.now()/40)%360)%360;
    ctx.fillStyle='hsl('+hue+' 90% 55%)';
    ctx.beginPath(); ctx.arc(sx,sy,r,0,Math.PI*2); ctx.fill();
  }
  ctx.fillStyle='rgba(255,255,255,.95)'; ctx.font='12px system-ui'; ctx.textAlign='center';
  ctx.fillText(snk.name, snk.x-cam.x, snk.y-cam.y - 18);
}

/* ======== –ë–£–°–¢–´ –ò –†–ï–ö–õ–ê–ú–ö–ê ======== */
boostBtn.addEventListener('pointerdown',function(e){e.preventDefault();if(mode==='worm')boostHold=true;},{passive:false});
['pointerup','pointercancel','touchend'].forEach(function(ev){ boostBtn.addEventListener(ev,function(){boostHold=false;}); });
invisBtn.onclick=function(){
  if (mode!=='worm') return;
  if (!invis){
    if (invCount>0){ invCount--; LS.set('invCount',invCount); invis=true; invisTimer=10; }
    else if (bank>=200){ if (confirm('–ö—É–ø–∏—Ç—å ¬´–ù–µ–≤–∏–¥–∏–º–∫–∞¬ª –∑–∞ 200 –æ—á–∫–æ–≤?')){ bank-=200; LS.set('bank',bank); invis=true; invisTimer=10; } }
    else alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤');
  }
};
function triggerAdAndRestart(){
  saveRecord(playerName, score); LS.set('bank', bank);
  adVideo.src='ad.mp4'; show(adWrap);
  function finish(){ adVideo.pause(); hide(adWrap); startWorm(bots.length); }
  adVideo.onended=finish; skipAd.onclick=finish;
}

/* ======== CAT (–∫–æ—Ä–æ—Ç–∫–æ) ======== */
var CAT_G=1400, CAT_JUMP=-760, CAT_BOUNCE=-800, CAT_SPEED=240, CAT_GAP_MIN=140, CAT_GAP_MAX=170;
var cat=null, tramps=[], camY=0, jumpRequest=false, airJump=true, minCamY=0;
function startCat(){
  mode='cat'; setScore(0); jumpRequest=false; airJump=true; showControls('cat');
  var W=canvas.clientWidth,H=canvas.clientHeight;
  cat={x:W/2,y:H*0.6,vx:0,vy:0,onGround:false};
  camY = cat.y - H*0.35; minCamY = camY; tramps=[];
  for (var i=0;i<14;i++) addTrampCat(i===0? (cat.y+40) : null);
}
function addTrampCat(constY){
  var W=canvas.clientWidth;
  var gap = CAT_GAP_MIN + Math.random()*(CAT_GAP_MAX-CAT_GAP_MIN);
  var newY = (typeof constY==='number') ? constY : (tramps.length ? tramps[tramps.length-1].y - gap : camY + 200);
  var x = 60 + Math.random()*(W-120);
  tramps.push({x:x, y:newY, w:Math.max(120, Math.min(220, W*0.3)), h:18});
}
jumpBtn.addEventListener('pointerdown',function(e){e.preventDefault();if(mode==='cat')jumpRequest=true;},{passive:false});
jumpBtn.addEventListener('touchstart',function(e){e.preventDefault();if(mode==='cat')jumpRequest=true;},{passive:false});
function updateCat(dt){
  var W=canvas.clientWidth,H=canvas.clientHeight;
  // –¥–ª—è Cat –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Å—å –¥–∂–æ–π—Å—Ç–∏–∫–∞, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω
  var move = joy.active ? joy.ax : 0; cat.vx = move * CAT_SPEED;
  cat.vy += CAT_G * dt; cat.x += cat.vx*dt; cat.y += cat.vy*dt;
  cat.x = Math.max(16, Math.min(W-16, cat.x));
  cat.onGround=false;
  for (var i=0;i<tramps.length;i++){ var t=tramps[i];
    if (cat.vy>0 && cat.y+12>=t.y && cat.y+12<=t.y+t.h+3 && cat.x>t.x && cat.x<t.x+t.w){
      cat.y=t.y-12; cat.vy=CAT_BOUNCE; cat.onGround=true; airJump=true; setScore(score+1);
    }
  }
  if (jumpRequest){ if (cat.onGround || airJump){ cat.vy=CAT_JUMP; if(!cat.onGround) airJump=false; } jumpRequest=false; }
  var desired=cat.y - H*0.35; if (desired < minCamY) minCamY = desired;
  if (minCamY < camY){ camY += (minCamY - camY)*Math.min(1,dt*6); if (Math.abs(minCamY-camY)<0.5) camY=minCamY; }
  var topY = tramps.length ? tramps[0].y : camY + 200;
  for (i=1;i<tramps.length;i++) if (tramps[i].y < topY) topY = tramps[i].y;
  while (topY > camY - H*0.8 && tramps.length < 60){
    addTrampCat(topY - (CAT_GAP_MIN + Math.random()*(CAT_GAP_MAX-CAT_GAP_MIN)));
    topY = tramps[0].y; for (i=1;i<tramps.length;i++) if (tramps[i].y < topY) topY = tramps[i].y;
  }
  for (i=tramps.length-1;i>=0;i--) if (tramps[i].y > camY + H + 200) tramps.splice(i,1);
  if (cat.y > camY + H + 240) showMain();
}
function drawCat(){
  var W=canvas.clientWidth,H=canvas.clientHeight;
  ctx.fillStyle='#0a0e19'; ctx.fillRect(0,0,W,H);
  // –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —Å —É—á—ë—Ç–æ–º –∫–∞–º–µ—Ä—ã –ø–æ Y
  ctx.fillStyle='#80ffd8'; ctx.strokeStyle='rgba(0,0,0,.25)'; ctx.lineWidth=1;
  for (var i=0;i<tramps.length;i++){ var t=tramps[i]; roundRect(t.x, t.y - camY, t.w, t.h, 10); ctx.fill(); ctx.stroke(); }
  drawCatSprite(cat.x, cat.y - camY);
}
function roundRect(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
function drawCatSprite(x,y){
  ctx.save(); ctx.translate(x,y);
  ctx.fillStyle='rgba(0,0,0,.25)'; ctx.beginPath(); ctx.ellipse(0,16,14,6,0,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#f59e0b'; roundRect(-12,-6,24,26,8); ctx.fill();
  ctx.beginPath(); ctx.fillStyle='#fca5a5'; ctx.arc(0,-16,11,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.moveTo(-8,-20); ctx.lineTo(-3,-28); ctx.lineTo(2,-20); ctx.closePath(); ctx.fill();
  ctx.beginPath(); ctx.moveTo(8,-20);  ctx.lineTo(3,-28);  ctx.lineTo(-2,-20); ctx.closePath(); ctx.fill();
  ctx.fillStyle='#111'; ctx.beginPath(); ctx.arc(-3.5,-17,2,0,Math.PI*2); ctx.arc(3.5,-17,2,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.strokeStyle='rgba(173,216,230,.9)'; ctx.lineWidth=3; ctx.arc(0,-16,14,0,Math.PI*2); ctx.stroke();
  ctx.restore();
}

/* ======== –û–ë–©–ò–ï –ö–ù–û–ü–ö–ò/–ö–û–ù–¢–†–û–õ–´ ======== */
function showControls(m){
  boostBtn.style.display = (m==='worm')?'inline-block':'none';
  invisBtn.style.display = (m==='worm')?'inline-block':'none';
  jumpBtn.style.display  = (m==='cat') ?'inline-block':'none';
}

/* ======== –ú–ï–•–ê–ù–ò–ö–ê/–ú–ê–¢–ï–ú–ê–¢–ò–ö–ê ======== */
function dist(ax,ay,bx,by){var dx=ax-bx, dy=ay-by; return Math.sqrt(dx*dx+dy*dy);}
function getNearest(arr,x,y){ var best=null, bd=1e9; for(var i=0;i<arr.length;i++){ var d=dist(x,y,arr[i].x,arr[i].y); if(d<bd){bd=d;best=arr[i];}} return best; }
function wrapAngle(a){ while(a>Math.PI)a-=2*Math.PI; while(a<-Math.PI)a+=2*Math.PI; return a; }
function mixAngle(a,b,t){ // –Ω–∞–∏–º–µ–Ω—å—à–∞—è –¥—É–≥–∞
  var da = wrapAngle(b-a); return a + da*t;
}

/* ======== –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ ======== */
var last=Date.now(), paused=false;
function loop(){
  var now=Date.now(), dt=Math.min(33, now-last)/1000; last=now;
  if (!paused){
    if (mode==='worm'){ updateWorm(dt); drawWorm(); }
    else if (mode==='cat'){ updateCat(dt); drawCat(); }
    else { ctx.fillStyle='#070c18'; ctx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight); }
  }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
document.addEventListener('visibilitychange', function(){ paused=document.hidden; });

/* ======== –°–¢–ê–†–¢ ======== */
function init(){
  updateBankUI();
  showMain();
}
init();
</script>
</body>
</html>