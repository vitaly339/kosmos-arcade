<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>KOSMOS.ARCADE ‚Äî Worm & Super Cat</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{background:#0b1020;color:#fff;font-family:system-ui,Arial;overflow:hidden}

/* top bar */
.top{position:fixed;left:0;right:0;top:0;display:flex;gap:8px;align-items:center;justify-content:space-between;
     padding:10px 12px;background:#0006;border-bottom:1px solid #ffffff18;z-index:5;backdrop-filter:blur(6px)}
.brand{font-weight:800;letter-spacing:.5px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.input,.btn,.chip{padding:8px 10px;border-radius:8px;border:1px solid #ffffff22;background:#ffffff10;color:#fff}
.btn{cursor:pointer}
.chip{font-weight:600}

/* menu */
.main{position:fixed;inset:56px 0 0 0;display:flex;align-items:center;justify-content:center}
.menu{display:grid;gap:12px;max-width:820px;width:92%}
.cards{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(260px,1fr))}
@media (max-width:720px){.cards{grid-template-columns:1fr}}
.card{border:1px solid #ffffff22;border-radius:12px;padding:14px;background:
  radial-gradient(140% 120% at 20% 0%,#182044 0%,transparent 60%),
  #0f1630; box-shadow:0 10px 30px #0007}
.card h3{margin-bottom:6px;font-weight:800;letter-spacing:.3px}
.card p{opacity:.85;margin-bottom:10px}

/* footer */
.footer{position:fixed;left:0;right:0;bottom:0;text-align:center;color:#9aa1b6;font-size:12px;padding:6px 0;border-top:1px solid #ffffff18;background:#0006;z-index:5}

/* HUD: –Ω–µ–≤–∏–¥–∏–º—ã–µ –∑–æ–Ω—ã */
.hud{position:fixed;inset:0;pointer-events:auto;display:none;z-index:6}
.hud.show{display:block}
/* –Ω–µ–≤–∏–¥–∏–º–∞—è –∑–æ–Ω–∞ –±—É—Å—Ç–∞ (—Å–ª–µ–≤–∞ –≤–Ω–∏–∑—É) */
#boostArea{position:absolute;left:12px;bottom:12px;width:120px;height:120px;border-radius:999px;touch-action:none;opacity:0}
/* –Ω–∞–ø—Ä–∞–≤–ª—è—é—â–∏–π –¥–∂–æ–π—Å—Ç–∏–∫ ‚Äî –≤–µ—Å—å –ø—Ä–∞–≤—ã–π —ç–∫—Ä–∞–Ω */
#aimArea{position:absolute;right:0;top:0;bottom:0;width:55vw;touch-action:none;opacity:0}

/* modal records */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);display:none;z-index:8;align-items:center;justify-content:center;padding:18px}
.modal.show{display:flex}
.box{width:min(640px,92vw);max-height:80vh;overflow:auto;border:1px solid #ffffff22;background:#0e152d;border-radius:12px}
.box-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #ffffff20}
.box-title{font-weight:800}
.box-body{padding:10px 12px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px 10px;border-bottom:1px solid #ffffff18;text-align:left}
.table th{opacity:.8}

/* show/hide menu */
.hide-when-playing{display:block}
.playing .hide-when-playing{display:none}
</style>
</head>
<body>
<header class="top">
  <div class="brand">KOSMOS.ARCADE</div>
  <div class="row">
    <span>–ò–º—è</span><input id="playerName" class="input" value="Kosmos" maxlength="16" style="width:130px">
    <span>–ë–æ—Ç–æ–≤</span><input id="botCount" class="input" type="number" min="0" max="30" value="12" style="width:68px">
    <div id="score" class="chip">0</div>
    <button id="btnRecords" class="btn">–†–µ–∫–æ—Ä–¥—ã</button>
    <button id="toMenu" class="btn">–í –º–µ–Ω—é</button>
  </div>
</header>

<main class="main hide-when-playing">
  <div class="menu">
    <div style="margin-bottom:6px;opacity:.9">–í—ã–±–∏—Ä–∞–π —Ä–µ–∂–∏–º</div>
    <div class="cards">
      <div class="card">
        <h3>üêç Worm</h3>
        <p>–ë–æ–ª—å—à–∞—è –∫–∞—Ä—Ç–∞, <b>–ø–ª–∞–≤–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ</b>, –±–æ—Ç—ã-–ø–ª–∞–Ω–µ—Ç—ã —Å —Ä–µ–≥–µ–Ω–æ–º, –ø—Ä–µ–¥–º–µ—Ç—ã: üí£ üèµÔ∏è üåà ‚ò¢Ô∏è. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: <b>–ø—Ä–∞–≤—ã–π —Å–≤–∞–π–ø-–¥–∂–æ–π—Å—Ç–∏–∫</b>, <b>–ª–µ–≤—ã–π –∫—Ä—É–≥ ‚Äî –±—É—Å—Ç</b>.</p>
        <button id="playWorm" class="btn">–ò–≥—Ä–∞—Ç—å</button>
      </div>
      <div class="card">
        <h3>üê± Super Cat (Jump)</h3>
        <p>–ü–æ–ª–Ω—ã–π –∫–æ—Ç –≤ —Å–∫–∞—Ñ–∞–Ω–¥—Ä–µ, –∞–≤—Ç–æ–ø—Ä—ã–∂–∫–∏, –Ω–µ–≤–∏–¥–∏–º—ã–π –¥–∂–æ–π—Å—Ç–∏–∫ —Å–ø—Ä–∞–≤–∞. (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.)</p>
        <button id="playCat" class="btn">–ò–≥—Ä–∞—Ç—å</button>
      </div>
    </div>
  </div>
</main>

<footer class="footer hide-when-playing">smooth glow + fat growth + invisible controls</footer>

<!-- HUD: –Ω–µ–≤–∏–¥–∏–º—ã–µ –∑–æ–Ω—ã -->
<div id="hud" class="hud">
  <div id="boostArea" title="–£—Å–∫–æ—Ä–µ–Ω–∏–µ"></div>
  <div id="aimArea"   title="–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"></div>
</div>

<!-- Records modal -->
<div id="recModal" class="modal">
  <div class="box">
    <div class="box-head">
      <div class="box-title">–¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤</div>
      <button id="closeRec" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="box-body">
      <h4 style="margin:6px 0">Worm</h4>
      <table class="table"><thead><tr><th>#</th><th>–ò–º—è</th><th>–û—á–∫–∏</th></tr></thead><tbody id="tbodyWorm"></tbody></table>
      <h4 style="margin:12px 0 6px">Super Cat</h4>
      <table class="table"><thead><tr><th>#</th><th>–ò–º—è</th><th>–û—á–∫–∏</th></tr></thead><tbody id="tbodyCat"></tbody></table>
    </div>
  </div>
</div>

<script>
/* ===== –æ–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã + —Ä–µ–∫–æ—Ä–¥—ã ===== */
const $ = s => document.querySelector(s);
const on = (el,ev,fn,opt)=>el&&el.addEventListener(ev,fn,opt);
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const rand =(a,b)=>a+Math.random()*(b-a);
const REC_W='kosmos_records_worm', REC_C='kosmos_records_cat';
function pushRec(key,name,score,limit=10){const a=JSON.parse(localStorage.getItem(key)||'[]');a.push({name,score,ts:Date.now()});a.sort((x,y)=>y.score-x.score);localStorage.setItem(key,JSON.stringify(a.slice(0,limit)));}
function fillTable(key,tbody){const a=JSON.parse(localStorage.getItem(key)||'[]');tbody.innerHTML=a.map((r,i)=>`<tr><td>${i+1}</td><td>${r.name}</td><td>${r.score}</td></tr>`).join('')||'<tr><td colspan="3" style="opacity:.7">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</td></tr>';}
on($('#btnRecords'),'click',()=>{fillTable(REC_W,$('#tbodyWorm'));fillTable(REC_C,$('#tbodyCat'));$('#recModal').classList.add('show');});
on($('#closeRec'),'click',()=>$('#recModal').classList.remove('show'));

/* ===== –∫–Ω–æ–ø–∫–∞ "–í –º–µ–Ω—é" ===== */
on($('#toMenu'),'click',()=>{ stopWorm(false); stopCat(false); document.body.classList.remove('playing'); $('#hud').classList.remove('show'); });

/* =======================================================================
   WORM ‚Äî –≥–ª–∞–¥–∫–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫—Ä—É–≥–∞–º–∏ + —Ä–æ—Å—Ç —Ç–æ–ª—â–∏–Ω—ã + –Ω–æ–≤—ã–µ –∑–æ–Ω—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
   ======================================================================= */
let wCanvas=null,wCtx=null,wRAF=null,wRun=false;
const WCFG={WORLD:3400,SPEED:2.35,BOOST:1.55,TURN:0.11,SEG:8,FOOD_R:4,FOOD_TARGET:170};
const wTouch={on:false,sx:0,sy:0,ex:0,ey:0}; // –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–∞–≤–æ–π –∑–æ–Ω—ã
let wSnakes=[], wFoods=[], wMe=null, wScore=0, wBoost=false;
const wCam={x:0,y:0};
const PLANETS=["–ú–∞—Ä—Å","–ó–µ–º–ª—è","–Æ–ø–∏—Ç–µ—Ä","–í–µ–Ω–µ—Ä–∞","–°–∞—Ç—É—Ä–Ω","–ù–µ–ø—Ç—É–Ω","–ú–µ—Ä–∫—É—Ä–∏–π","–£—Ä–∞–Ω","–ü–ª—É—Ç–æ–Ω","–ï–≤—Ä–æ–ø–∞","–ò–æ","–¢–∏—Ç–∞–Ω","–ì–∞–Ω–∏–º–µ–¥","–ö–∞–ª–ª–∏—Å—Ç–æ","–¢—Ä–∏—Ç–æ–Ω"];
const COLORS=['#6bf2ff','#7eff6b','#ff6be6','#ffaa6b','#7aa3ff','#ffd86b'];
const FOOD_TYPES=['dot','bomb','flower','rainbow','rad','mass']; // mass ‚Äî –º—è—Å–æ –æ—Ç —É–±–∏—Ç—ã—Ö
const FOOD_PROB ={dot:0.90,bomb:0.02,flower:0.03,rainbow:0.03,rad:0.02};

function wHead(s){return s.segs[0];}
function wDist2(a,b){const dx=a.x-b.x,dy=a.y-b.y;return dx*dx+dy*dy;}
function lerp(a,b,t){return a+(b-a)*t;}
function wLerpAng(a,b,t){let d=((b-a+Math.PI*3)%(Math.PI*2))-Math.PI;return a+d*t;}
const rndColor=()=>COLORS[Math.floor(Math.random()*COLORS.length)];

function wNewSnake(x,y,isP=false,name='bot',color='#6bf2ff'){
  const dir=Math.random()*Math.PI*2;
  const s={isP,alive:true,name,color,dir,segs:[],grow:0,baseR:12,fatUntil:0,radUntil:0,radShrink:0};
  const L=28+Math.floor(Math.random()*10);
  for(let i=0;i<L;i++) s.segs.push({x:x-i*WCFG.SEG*Math.cos(dir),y:y-i*WCFG.SEG*Math.sin(dir)});
  return s;
}

function wSpawn(){
  wSnakes=[]; wFoods=[];
  const meName=($('#playerName').value||'Kosmos').slice(0,16);
  wMe = wNewSnake(rand(900,1400),rand(900,1400),true,meName,'#6bf2ff');
  wSnakes.push(wMe); wSpawnBots();
  for(let i=0;i<140;i++) wFoods.push(wMakeFood());
  wScore=0; $('#score').textContent=0;
}

function wSpawnBots(){
  const need = clamp(parseInt($('#botCount').value||12,10),0,30);
  while (wSnakes.filter(s=>!s.isP&&s.alive).length<need){
    const name = PLANETS[Math.floor(Math.random()*PLANETS.length)];
    const col  = COLORS[Math.floor(Math.random()*COLORS.length)];
    wSnakes.push(wNewSnake(rand(200,WCFG.WORLD-200),rand(200,WCFG.WORLD-200),false,name,col));
  }
}

function wMakeFood(){
  const r=Math.random(); let type='dot',acc=0;
  for(const t of FOOD_TYPES){acc+=FOOD_PROB[t]; if(r<=acc){type=t;break;}}
  return {x:rand(40,WCFG.WORLD-40), y:rand(40,WCFG.WORLD-40), type, sz:1};
}
function wEnsureFood(){ while(wFoods.length<WCFG.FOOD_TARGET) wFoods.push(wMakeFood()); }

function wResize(){ wCanvas.width=innerWidth; wCanvas.height=innerHeight; }
function wCamUpdate(){
  if(!wMe) return;
  wCam.x = wHead(wMe).x - wCanvas.width/2;
  wCam.y = wHead(wMe).y - wCanvas.height/2;
  wCam.x = clamp(wCam.x, 0, WCFG.WORLD-wCanvas.width);
  wCam.y = clamp(wCam.y, 0, WCFG.WORLD-wCanvas.height);
}

let lastTs=0;
function wUpdate(ts){
  if(!lastTs) lastTs=ts;
  const dt = Math.min(32, ts - lastTs); // –º—Å, –∫–∞–ø
  lastTs = ts;

  // —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –ø—Ä–∞–≤–∞—è –∑–æ–Ω–∞)
  if(wTouch.on){
    const a=Math.atan2(wTouch.ey-wTouch.sy, wTouch.ex-wTouch.sx);
    if(isFinite(a)) wMe.dir = wLerpAng(wMe.dir, a, WCFG.TURN * (dt/16)*1.6);
  }

  for(const s of wSnakes){
    if(!s.alive) continue;
    if(!s.isP){ s.dir = wLerpAng(s.dir, s.dir + rand(-0.3,0.3), 0.04*(dt/16)); }

    // —Ç–µ–∫—É—â–∏–π —Ä–∞–¥–∏—É—Å —Å —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏
    const now=performance.now();
    const targetR = (now<s.fatUntil ? s.baseR*1.8 : s.baseR);
    const radCut  = (now<s.radUntil ? (0.5 + s.radShrink*0.5) : 1); // —Å–∂–∏–º–∞–µ—Ç—Å—è
    s.baseR = clamp(s.baseR, 10, 30); // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–æ–ª—â–∏–Ω—ã
    s.r = clamp(targetR*radCut, 8, 34);

    const speed = (s.isP && wBoost ? WCFG.SPEED*WCFG.BOOST : WCFG.SPEED) * (dt/16);
    const nx=wHead(s).x+Math.cos(s.dir)*speed, ny=wHead(s).y+Math.sin(s.dir)*speed;
    s.segs.unshift({x:nx,y:ny});
    // —Ä–æ—Å—Ç –¥–ª–∏–Ω—ã: —Ä–∞—Å—Ç—ë—Ç –Ω–µ–º–Ω–æ–≥–æ –≤—Å–µ–≥–¥–∞, —Å–∏–ª—å–Ω–µ–µ –æ—Ç "–º—è—Å–∞"
    if(s.grow>0) s.grow--; else if(s.segs.length>28) s.segs.pop();

    // –µ–¥–∞/–ø—Ä–µ–¥–º–µ—Ç—ã
    for(let i=wFoods.length-1;i>=0;i--){
      const f=wFoods[i];
      const rr = (s.r + (f.type==='mass'? 6 : WCFG.FOOD_R) + 4);
      if(wDist2(wHead(s),f) < rr*rr){
        wFoods.splice(i,1);
        if(f.type==='dot'){ s.grow+=5; if(s.isP){wScore++; $('#score').textContent=wScore;} }
        else if(f.type==='bomb'){ s.alive=false; if(s.isP) return stopWorm(true); }
        else if(f.type==='flower'){ s.fatUntil = now+15000; }
        else if(f.type==='rainbow'){ s.color = rndColor(); }
        else if(f.type==='rad'){ s.radUntil = now+10000; s.radShrink=0; }
        else if(f.type==='mass'){ 
          // –∏–º–µ–Ω–Ω–æ –æ—Ç ¬´–º—è—Å–∞¬ª —Ä–∞—Å—Ç—ë—Ç —Ç–æ–ª—â–∏–Ω–∞ —Å–∏–ª—å–Ω–µ–µ
          s.baseR = clamp(s.baseR + 0.45*f.sz, 10, 34);
          s.grow += Math.ceil(4*f.sz);
          if(s.isP){ wScore += 3*f.sz|0; $('#score').textContent=wScore; }
        }
      }
    }

    // –∫—Ä–∞–π –º–∏—Ä–∞
    const h=wHead(s); if(h.x<0)h.x+=WCFG.WORLD; if(h.x>WCFG.WORLD)h.x-=WCFG.WORLD; if(h.y<0)h.y+=WCFG.WORLD; if(h.y>WCFG.WORLD)h.y-=WCFG.WORLD;
  }

  // —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è –≥–æ–ª–æ–≤–∞/—Ç–µ–ª–æ
  for(const a of wSnakes){
    if(!a.alive) continue;
    for(const b of wSnakes){
      if(a===b || !b.alive) continue;
      const R2=(a.r + b.r*0.85)**2, H=wHead(a);
      for(const seg of b.segs){
        if(wDist2(H,seg)<=R2){
          a.alive=false; // –ø—Ä–æ–∏–≥—Ä–∞–ª
          if(a.isP) return stopWorm(true);
          // —Ç—É—à–∫–∞ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ ¬´–º—è—Å–æ¬ª (—É–º–µ–Ω—å—à–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω–æ)
          dropMeat(a);
          break;
        }
      }
    }
  }

  // —á–∏—Å—Ç–∫–∞ –∏ —Ä–µ–≥–µ–Ω
  wSnakes = wSnakes.filter(s=>s.alive);
  wSpawnBots(); wEnsureFood();
}

function dropMeat(s){
  for(let i=0;i<s.segs.length;i+=2){
    const p=s.segs[i];
    wFoods.push({x:p.x,y:p.y,type:'mass',sz:1});
  }
}

function wDrawFood(f){
  const ctx=wCtx;
  ctx.save(); ctx.textBaseline='middle'; ctx.textAlign='center';
  if(f.type==='dot'){
    ctx.beginPath(); ctx.arc(f.x,f.y,WCFG.FOOD_R,0,Math.PI*2);
    ctx.fillStyle='#00ffd5'; ctx.shadowBlur=12; ctx.shadowColor='#00ffd5'; ctx.fill();
  } else if(f.type==='mass'){
    ctx.beginPath(); ctx.arc(f.x,f.y,6*f.sz,0,Math.PI*2);
    ctx.fillStyle='#ffd36b'; ctx.shadowBlur=14; ctx.shadowColor='#ffd36b'; ctx.fill();
  } else {
    ctx.font='20px "Apple Color Emoji","Segoe UI Emoji",system-ui'; const map={bomb:'üí£',flower:'üèµÔ∏è',rainbow:'üåà',rad:'‚ò¢Ô∏è'};
    ctx.fillText(map[f.type]||'‚ùì',f.x,f.y+1);
  }
  ctx.restore();
}

/* —Ä–∏—Å—É–µ–º –∑–º–µ–π –∫–∞–∫ –Ω–∞–±–æ—Ä –∫—Ä—É–≥–æ–≤ -> –Ω–µ—Ç –ø–æ–ª–æ—Å –∏ —Ä–∞–∑—Ä—ã–≤–æ–≤ */
function drawSnakeSmooth(s){
  const ctx=wCtx, now=performance.now();
  // glow
  ctx.save();
  ctx.globalCompositeOperation='lighter';
  ctx.shadowColor = (now<s.radUntil? '#8cff7a' : s.color);
  ctx.shadowBlur = 20;
  for(let i=0;i<s.segs.length;i+=2){
    const p=s.segs[i];
    ctx.beginPath(); ctx.arc(p.x,p.y,s.r,0,Math.PI*2); ctx.fillStyle=s.color; ctx.fill();
  }
  ctx.restore();
  // —Ç–µ–ª–æ
  for(let i=0;i<s.segs.length;i+=1){
    const p=s.segs[i];
    ctx.beginPath(); ctx.arc(p.x,p.y,s.r,0,Math.PI*2); ctx.fillStyle=s.color; ctx.fill();
  }
  // –≥–ª–∞–∑–∞ + –Ω–∏–∫
  const h=wHead(s), dpx=Math.cos(s.dir), dpy=Math.sin(s.dir), nx=-dpy, ny=dpx, off=s.r*.6, eye=s.r*.45;
  // –≥–ª–∞–∑–∞
  ctx.beginPath(); ctx.fillStyle='#fff';
  ctx.arc(h.x+nx*off+dpx*.6, h.y+ny*off+dpy*.6, eye, 0, Math.PI*2);
  ctx.arc(h.x-nx*off+dpx*.6, h.y-ny*off+dpy*.6, eye, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.fillStyle='#111';
  ctx.arc(h.x+nx*off+dpx*1.0, h.y+ny*off+dpy*1.0, eye*.45, 0, Math.PI*2);
  ctx.arc(h.x-nx*off+dpx*1.0, h.y-ny*off*dpy*1.0, eye*.45, 0, Math.PI*2); ctx.fill();
  // –Ω–∏–∫ ‚Äî —á—ë—Ç–∫–∏–π
  wCtx.font='600 13px system-ui,Arial'; wCtx.textAlign='center'; wCtx.textBaseline='bottom';
  wCtx.fillStyle='#e7f7ff'; wCtx.strokeStyle='#08121f'; wCtx.lineWidth=2;
  const nxp=Math.round(h.x)+0.5, nyp=Math.round(h.y - s.r*1.7)+0.5;
  wCtx.strokeText(s.name,nxp,nyp); wCtx.fillText(s.name,nxp,nyp);
}

function wDraw(){
  const ctx=wCtx;
  ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,wCanvas.width,wCanvas.height);
  ctx.translate(-wCam.x,-wCam.y);

  // —Ñ–æ–Ω
  ctx.fillStyle='#06101a'; ctx.fillRect(wCam.x,wCam.y,wCanvas.width,wCanvas.height);

  // –µ–¥–∞
  for(const f of wFoods) wDrawFood(f);

  // –∑–º–µ–∏
  for(const s of wSnakes) drawSnakeSmooth(s);
}

function wStep(ts){
  if(!wRun) return;
  wUpdate(ts); wCamUpdate(); wDraw();
  wRAF=requestAnimationFrame(wStep);
}

function startWorm(){
  if(wRun) return;
  document.body.classList.add('playing'); $('#hud').classList.add('show');
  wCanvas=document.createElement('canvas'); wCanvas.style.position='fixed'; wCanvas.style.inset='0'; wCanvas.style.zIndex='3'; wCanvas.style.touchAction='none';
  document.body.appendChild(wCanvas); wCtx=wCanvas.getContext('2d'); wRun=true; wResize(); addEventListener('resize',wResize);
  wSpawn(); lastTs=0; wRAF=requestAnimationFrame(wStep);
}
function stopWorm(save=false){
  if(!wRun) return;
  wRun=false; cancelAnimationFrame(wRAF); removeEventListener('resize',wResize);
  wCanvas.remove(); document.body.classList.remove('playing'); $('#hud').classList.remove('show');
  if(save && wMe) pushRec(REC_W, wMe.name, wScore);
}

/* --- —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ø—Ä–∞–≤—ã–π –¥–∂–æ–π—Å—Ç–∏–∫ + –ª–µ–≤—ã–π –Ω–µ–≤–∏–¥–∏–º—ã–π –±—É—Å—Ç --- */
const aim = $('#aimArea'), boostArea = $('#boostArea');
let aimId=null, boostId=null;

function aimStart(e){ const t=e.changedTouches?e.changedTouches[0]:e; if(t.clientX < innerWidth*0.45) return; aimId=t.identifier??'mouse'; wTouch.on=true; wTouch.sx=wTouch.ex=t.clientX; wTouch.sy=wTouch.ey=t.clientY; }
function aimMove (e){ for(const t of (e.changedTouches||[e])){ const id=t.identifier??'mouse'; if(id!==aimId) continue; wTouch.ex=t.clientX; wTouch.ey=t.clientY; } }
function aimEnd  (e){ for(const t of (e.changedTouches||[e])){ const id=t.identifier??'mouse'; if(id===aimId){ wTouch.on=false; aimId=null; } } }

function boostStart(e){ const t=e.changedTouches?e.changedTouches[0]:e; boostId=t.identifier??'mouse'; wBoost=true; e.preventDefault(); }
function boostEnd  (e){ for(const t of (e.changedTouches||[e])){ const id=t.identifier??'mouse'; if(id===boostId){ wBoost=false; boostId=null; } } }

on(aim,'touchstart',aimStart,{passive:false}); on(aim,'touchmove',aimMove,{passive:true}); on(aim,'touchend',aimEnd,{passive:true});
on(aim,'mousedown',aimStart); on(aim,'mousemove',aimMove); on(aim,'mouseup',aimEnd);

on(boostArea,'touchstart',boostStart,{passive:false}); on(boostArea,'touchend',boostEnd,{passive:true});
on(boostArea,'mousedown',boostStart); on(boostArea,'mouseup',boostEnd);

on($('#playWorm'),'click',startWorm);

/* =======================================================================
   SUPER CAT ‚Äî –æ—Å—Ç–∞–≤–ª–µ–Ω –∫–∞–∫ –≤ —Ä–∞–±–æ—á–µ–π –≤–µ—Ä—Å–∏–∏ (–Ω–µ–≤–∏–¥–∏–º—ã–π –¥–∂–æ–π—Å—Ç–∏–∫ —Å–ø—Ä–∞–≤–∞)
   ======================================================================= */
let cCanvas=null,cCtx=null,cRAF=null,cRun=false;
const cat={x:0,y:0,vx:0,vy:-8,w:36,h:46,face:1};
const cJoy={on:false,sx:0,sy:0,ex:0,ey:0};
let camY=0, cScore=0, plats=[];

function cReset(){
  plats=[]; cScore=0; camY=0;
  cat.x=innerWidth/2; cat.y=0; cat.vx=0; cat.vy=-8; cat.face=1;
  let y=0; for(let i=0;i<28;i++){ plats.push(cMake(rand(40,innerWidth-160), y, cType())); y -= rand(70,110); }
}
function cType(){ const r=Math.random(); if(r<0.2) return 'move'; if(r<0.28) return 'break'; return 'solid'; }
function cMake(x,y,type){ const w = type==='solid'?rand(80,150):rand(90,150); return {x,y,w,type,dir:Math.random()<.5?-1:1,life:1,off:Math.random()*1000}; }
function cEnsure(){
  let topY = plats.length? Math.min(...plats.map(p=>p.y)) : 0;
  while (topY > camY - 1400){ topY -= rand(70,110); plats.push(cMake(rand(30,innerWidth-160), topY, cType())); }
  plats = plats.filter(p=>p.y < camY + innerHeight + 200 && p.life>0);
}

function cJoySet(dx){ const ax = clamp(dx*0.06, -1, 1); cat.vx = clamp(cat.vx+ax, -6, 6); if(Math.abs(ax)>0.01) cat.face=ax>0?1:-1; }
function cInput(){ if(cJoy.on){ cJoySet(cJoy.ex-cJoy.sx); } }
function cPhys(){
  cat.vy += 0.35; cat.x += cat.vx; cat.y += cat.vy; cat.vx *= 0.992;
  if(cat.x<-cat.w)cat.x=innerWidth+cat.w; if(cat.x>innerWidth+cat.w)cat.x=-cat.w;

  for(const p of plats){ if(p.type==='move'){ p.x += p.dir*1.2*Math.sin((performance.now()+p.off)/800); p.x=clamp(p.x,10,innerWidth-p.w-10); } }

  if(cat.vy>0){
    for(const p of plats){
      if(cat.y+cat.h/2>p.y && cat.y+cat.h/2<p.y+14 && cat.x>p.x && cat.x<p.x+p.w){
        if(p.type==='break'){ p.life=0; } else { cat.vy = -10; }
      }
    }
  }
  camY = Math.min(camY,cat.y-innerHeight*0.45);
  cScore = Math.max(cScore, Math.round(-(cat.y-0)));
  $('#score').textContent = cScore;
}

function cDrawCat(){
  const ctx=cCtx, x=cat.x, y=cat.y-camY, f=cat.face, w=cat.w, h=cat.h;
  // —Ö–≤–æ—Å—Ç
  ctx.save(); ctx.translate(x - f*w*0.35, y + h*0.05); ctx.rotate(Math.sin(performance.now()/150)*0.2*f);
  ctx.beginPath(); ctx.ellipse(0,0, w*0.28, h*0.18, 0, 0, Math.PI*2); ctx.fillStyle='#f7c38b'; ctx.fill(); ctx.restore();
  // —Ç–µ–ª–æ
  ctx.beginPath(); if (ctx.roundRect) ctx.roundRect(x - w*0.35, y - h*0.4, w*0.7, h*0.8, 12); else ctx.rect(x - w*0.35, y - h*0.4, w*0.7, h*0.8);
  ctx.fillStyle='#ffd9a8'; ctx.fill();
  // –ª–∞–ø—ã
  const step=Math.sin(performance.now()/120)*3; ctx.fillStyle='#ffc891';
  ctx.fillRect(x - w*0.28 + step*f, y + h*0.35, w*0.22, 6);
  ctx.fillRect(x + w*0.06 + step*f,  y + h*0.35, w*0.22, 6);
  // –≥–æ–ª–æ–≤–∞
  ctx.beginPath(); ctx.ellipse(x, y - h*0.55, w*0.42, h*0.33, 0, 0, Math.PI*2); ctx.fillStyle='#ffd9a8'; ctx.fill();
  // —É—à–∫–∏
  ctx.beginPath(); ctx.moveTo(x - w*0.28, y - h*0.76); ctx.lineTo(x - w*0.14, y - h*0.98); ctx.lineTo(x - w*0.02, y - h*0.70); ctx.closePath(); ctx.fillStyle='#ffb77a'; ctx.fill();
  ctx.beginPath(); ctx.moveTo(x + w*0.28, y - h*0.76); ctx.lineTo(x + w*0.14, y - h*0.98); ctx.lineTo(x + w*0.02, y - h*0.70); ctx.closePath(); ctx.fillStyle='#ffb77a'; ctx.fill();
  // –≥–ª–∞–∑–∞/–Ω–æ—Å
  const ex=x+f*w*0.10; ctx.beginPath(); ctx.fillStyle='#222';
  ctx.arc(ex - w*0.12, y - h*0.58, 3.6, 0, Math.PI*2);
  ctx.arc(ex + w*0.12, y - h*0.58, 3.6, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(x, y - h*0.50, 2.4, 0, Math.PI*2); ctx.fillStyle='#e27b7b'; ctx.fill();
}

function cDraw(){
  const ctx=cCtx; ctx.clearRect(0,0,cCanvas.width,cCanvas.height);
  const g=ctx.createLinearGradient(0,0,0,innerHeight); g.addColorStop(0,'#0c1430'); g.addColorStop(1,'#091224');
  ctx.fillStyle=g; ctx.fillRect(0,0,cCanvas.width,cCanvas.height);
  for(const p of plats){ const y=p.y-camY; if(y<-40||y>innerHeight+40) continue;
    ctx.fillStyle = p.type==='solid' ? '#21d1a3' : (p.type==='move' ? '#2db3ff' : '#ff7676');
    ctx.fillRect(p.x,y,p.w,10);
  }
  cDrawCat();
}

function cStep(){ if(!cRun) return; cInput(); cPhys(); cEnsure(); cDraw(); cRAF=requestAnimationFrame(cStep); }
function cResize(){ cCanvas.width=innerWidth; cCanvas.height=innerHeight; cEnsure(); }

function startCat(){
  if(cRun) return;
  document.body.classList.add('playing'); $('#hud').classList.add('show');
  cCanvas=document.createElement('canvas'); cCanvas.style.position='fixed'; cCanvas.style.inset='0'; cCanvas.style.zIndex='3'; cCanvas.style.touchAction='none';
  document.body.appendChild(cCanvas); cCtx=cCanvas.getContext('2d'); addEventListener('resize',cResize); cResize(); cReset(); bindCatJoy();
  cRun=true; cRAF=requestAnimationFrame(cStep);
}
function stopCat(save=false){
  if(!cRun) return;
  cRun=false; cancelAnimationFrame(cRAF); removeEventListener('resize',cResize);
  cCanvas.remove(); document.body.classList.remove('playing'); $('#hud').classList.remove('show');
  if(save){ const n=($('#playerName').value||'Kosmos').slice(0,16); pushRec(REC_C,n,cScore); }
}

/* —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ cat ‚Äî –ø—Ä–∞–≤—ã–π –¥–∂–æ–π—Å—Ç–∏–∫ */
function cJoyStart(e){ const t=e.changedTouches?e.changedTouches[0]:e; if(t.clientX<innerWidth*0.45) return; cJoy.on=true; cJoy.sx=cJoy.ex=t.clientX; cJoy.sy=cJoy.ey=t.clientY; }
function cJoyMove (e){ for(const t of (e.changedTouches||[e])){ if(!cJoy.on) continue; cJoy.ex=t.clientX; cJoy.ey=t.clientY; } }
function cJoyEnd  (){ cJoy.on=false; }
function bindCatJoy(){
  const aim=$('#aimArea');
  on(aim,'touchstart',cJoyStart,{passive:false}); on(aim,'touchmove',cJoyMove,{passive:true}); on(aim,'touchend',cJoyEnd,{passive:true});
  on(aim,'mousedown',cJoyStart); on(aim,'mousemove',cJoyMove); on(aim,'mouseup',cJoyEnd);
}

/* —Å—Ç–∞—Ä—Ç */
on($('#playCat'),'click',startCat);
</script>
</body>
</html>