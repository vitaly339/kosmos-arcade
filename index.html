<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Cosmo Arcade ‚Äî Switch + Camera</title>
<style>
  html,body{margin:0;height:100%;background:#0a1020;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;-webkit-user-select:none;user-select:none;touch-action:none}
  #wrap{display:flex;flex-direction:column;height:100dvh}
  header{padding:8px 12px;background:#121a36;border-bottom:1px solid #22325a;display:flex;gap:8px;align-items:center}
  header h1{font-size:16px;margin:0}
  #ui{margin-left:auto;display:flex;gap:8px;align-items:center}
  #score{padding:6px 10px;background:#0f1a36;border:1px solid #2b3f6f;border-radius:8px;font-weight:700}
  .hbtn{padding:6px 10px;background:#182a56;border:1px solid #3a5aa0;border-radius:8px;color:#fff;font-weight:700;cursor:pointer}

  #stage{position:relative;flex:1;min-height:0}
  #canvas{position:absolute;inset:0;display:block;width:100%;height:100%;touch-action:none;background:#0a0e19;z-index:1}

  #menu{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(8,12,24,.85);z-index:3}
  .card{background:#0f1730;border:1px solid #2b3f6f;border-radius:12px;padding:16px;max-width:420px;width:92%}
  .btn{display:block;width:100%;padding:14px 16px;margin:8px 0;background:#182a56;border:1px solid #3a5aa0;border-radius:10px;color:#fff;font-weight:700;text-align:center;cursor:pointer}

  #touch{position:absolute;left:10px;right:10px;bottom:10px;display:flex;justify-content:space-between;gap:10px;z-index:4}
  .joy{position:relative;display:none;width:120px;height:120px;border-radius:50%;background:#0b1430cc;border:1px solid #2b3e68}
  .joy.small{width:100px;height:100px}
  .knob{position:absolute;left:50%;top:50%;width:56px;height:56px;border-radius:50%;background:#172a58;border:1px solid #3b5ca0;transform:translate(-50%,-50%)}
  .joy.small .knob{width:48px;height:48px}

  #jumpBtn{
    position:absolute; right:12px; bottom:130px;
    padding:14px 18px; font-size:18px; font-weight:800; color:#fff;
    background:#1c2f5e; border:1px solid #3b5ca0; border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,.35);
    display:none; z-index:5;
  }
</style>
</head>
<body>
<div id="wrap">
  <header>
    <h1>Cosmo Arcade</h1>
    <div id="ui">
      <div id="score">0</div>
      <button id="switchBtn" class="hbtn" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∏–≥—Ä—É">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∏–≥—Ä—É</button>
      <button id="back" class="hbtn" title="–í –º–µ–Ω—é">–í –º–µ–Ω—é</button>
    </div>
  </header>

  <div id="stage">
    <canvas id="canvas"></canvas>

    <div id="menu">
      <div class="card">
        <button class="btn" data-mode="worm">üêç –ó–∞–ø—É—Å—Ç–∏—Ç—å Worm</button>
        <button class="btn" data-mode="cat">üê± –ó–∞–ø—É—Å—Ç–∏—Ç—å Cat</button>
        <p style="opacity:.8;font-size:12px;margin:6px 0 0 0">
          Worm: –ª–µ–≤—ã–π –¥–∂–æ–π—Å—Ç–∏–∫ –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç.<br>
          Cat: –ø—Ä–∞–≤—ã–π –¥–∂–æ–π—Å—Ç–∏–∫ —Ö–æ–¥–∏—Ç, ‚§¥Ô∏é Jump –∏ –ª—é–±–æ–π —Ç–∞–ø ‚Äî –ø—Ä—ã–∂–æ–∫. –ö–∞–º–µ—Ä–∞ —Å–ª–µ–¥—É–µ—Ç –≤–≤–µ—Ä—Ö.
        </p>
      </div>
    </div>

    <div id="touch">
      <div class="joy" id="joyLeft"><div class="knob"></div></div>
      <div class="joy small" id="joyRight"><div class="knob"></div></div>
      <button id="jumpBtn" type="button" aria-label="jump">‚§¥Ô∏é Jump</button>
    </div>
  </div>
</div>

<script>
/* –æ—Ç–∫–ª—é—á–∏–º —Å—Ç–∞—Ä—ã–π SW (–∫—ç—à) */
(function(){try{
  if ('serviceWorker' in navigator && navigator.serviceWorker.getRegistrations) {
    navigator.serviceWorker.getRegistrations().then(function(rs){ rs.forEach(function(r){ r.unregister(); }); });
  }
}catch(e){} })();

/* DOM */
var canvas = document.getElementById('canvas');
var ctx = canvas.getContext('2d');
var menu = document.getElementById('menu');
var scoreEl = document.getElementById('score');
var joyLeftEl  = document.getElementById('joyLeft');
var joyRightEl = document.getElementById('joyRight');
var jumpBtn    = document.getElementById('jumpBtn');
var switchBtn  = document.getElementById('switchBtn');
var backBtn    = document.getElementById('back');

function resize(){
  var r = Math.max(1, Math.min(window.devicePixelRatio || 1, 3));
  var w = canvas.parentElement.clientWidth;
  var h = canvas.parentElement.clientHeight;
  canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
  canvas.width = Math.floor(w*r); canvas.height = Math.floor(h*r);
  ctx.setTransform(r,0,0,r,0,0);
}
window.addEventListener('resize', resize); resize();

var state='menu', score=0;
function setScore(v){ score=v|0; scoreEl.textContent=score; }
function showControls(mode){
  joyLeftEl.style.display  = (mode==='worm') ? 'block' : 'none';
  joyRightEl.style.display = (mode==='cat')  ? 'block' : 'none';
  jumpBtn.style.display    = (mode==='cat')  ? 'block' : 'none';
}
function showMenu(){ state='menu'; menu.style.display='flex'; showControls('none'); }
function hideMenu(){ menu.style.display='none'; }
document.querySelectorAll('[data-mode]').forEach(function(b){
  b.addEventListener('click', function(){
    var m = this.getAttribute('data-mode');
    if (m==='worm'){ startWorm(); state='worm'; showControls('worm'); }
    else { startCat(); state='cat'; showControls('cat'); }
    hideMenu();
  });
});
backBtn.addEventListener('click', showMenu);

/* –ö–ù–û–ü–ö–ê –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø –ò–ì–†–´ ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –º–µ–Ω—è–µ—Ç —Ä–µ–∂–∏–º */
switchBtn.addEventListener('click', function(){
  if (state==='worm'){ startCat(); state='cat'; showControls('cat'); }
  else if (state==='cat'){ startWorm(); state='worm'; showControls('worm'); }
});

/* –î–∂–æ–π—Å—Ç–∏–∫ (ES5) */
function makeJoystick(root, radius){
  var knob = root.querySelector('.knob');
  var st = {ax:0, ay:0, active:false};
  var rect=null, id=null;
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function setKnob(ax,ay){
    knob.style.left = (50 + clamp(ax,-1,1)*50) + '%';
    knob.style.top  = (50 + clamp(ay,-1,1)*50) + '%';
    knob.style.transform = 'translate(-50%,-50%)';
  }
  function reset(){ st.ax=0; st.ay=0; st.active=false; setKnob(0,0); }
  function startXY(x,y,pid){
    id = pid; rect = root.getBoundingClientRect(); st.active = true;
    var cx = rect.left + rect.width/2, cy = rect.top + rect.height/2;
    st.ax = clamp((x-cx)/radius,-1,1);
    st.ay = clamp((y-cy)/radius,-1,1);
    setKnob(st.ax, st.ay);
  }
  function moveXY(x,y){
    if (!st.active) return;
    var cx = rect.left + rect.width/2, cy = rect.top + rect.height/2;
    st.ax = clamp((x-cx)/radius,-1,1);
    st.ay = clamp((y-cy)/radius,-1,1);
    setKnob(st.ax, st.ay);
  }
  function endXY(){ reset(); }

  root.addEventListener('pointerdown', function(e){ e.preventDefault(); if (root.setPointerCapture) root.setPointerCapture(e.pointerId); startXY(e.clientX,e.clientY,e.pointerId); }, {passive:false});
  root.addEventListener('pointermove',  function(e){ if(e.pointerId!==id) return; moveXY(e.clientX,e.clientY); });
  root.addEventListener('pointerup',    function(e){ if(e.pointerId!==id) return; endXY(); });
  root.addEventListener('pointercancel',function(){ endXY(); });

  root.addEventListener('touchstart', function(e){ e.preventDefault(); var t=e.changedTouches[0]; startXY(t.clientX,t.clientY,'t'); }, {passive:false});
  root.addEventListener('touchmove',  function(e){ e.preventDefault(); var t=e.changedTouches[0]; moveXY(t.clientX,t.clientY); }, {passive:false});
  root.addEventListener('touchend',   function(e){ e.preventDefault(); endXY(); }, {passive:false});

  setKnob(0,0);
  return st;
}
var joyLeft  = makeJoystick(joyLeftEl, 50); // Worm
var joyRight = makeJoystick(joyRightEl, 40); // Cat

/* ===== WORM (–º–∏–Ω–∏–º–∞–ª) ===== */
var worm=null, foods=[];
function startWorm(){
  setScore(0);
  var W=canvas.clientWidth, H=canvas.clientHeight;
  worm={x:W/2,y:H/2, ang:-Math.PI/2, spd:Math.min(W,H)*0.19, trail:[], segs:14, step:4};
  foods=[]; var n=Math.round((W*H)/9000);
  for(var i=0;i<n;i++) foods.push({x:Math.random()*W, y:Math.random()*H});
}
function updateWorm(dt){
  if (joyLeft.active){ worm.ang = Math.atan2(joyLeft.ay, joyLeft.ax); }
  worm.x += Math.cos(worm.ang)*worm.spd*dt;
  worm.y += Math.sin(worm.ang)*worm.spd*dt;
  var W=canvas.clientWidth,H=canvas.clientHeight;
  if (worm.x<0) worm.x+=W; if (worm.x>W) worm.x-=W;
  if (worm.y<0) worm.y+=H; if (worm.y>H) worm.y-=H;
  worm.trail.unshift({x:worm.x,y:worm.y}); if (worm.trail.length>1400) worm.trail.pop();
  for (var i=foods.length-1;i>=0;i--){
    var f=foods[i]; var dx=f.x-worm.x, dy=f.y-worm.y;
    if (Math.sqrt(dx*dx+dy*dy)<12){ foods.splice(i,1); setScore(score+5); foods.push({x:Math.random()*W,y:Math.random()*H}); }
  }
}
function drawWorm(){
  var W=canvas.clientWidth,H=canvas.clientHeight;
  ctx.fillStyle='#0a0e19'; ctx.fillRect(0,0,W,H);
  ctx.fillStyle='#67c8ff'; for (var i=0;i<foods.length;i++){ var f=foods[i]; ctx.beginPath(); ctx.arc(f.x,f.y,3.5,0,Math.PI*2); ctx.fill(); }
  for (var s=0;s<worm.segs;s++){
    var p = worm.trail[s*worm.step] || worm, r=Math.max(3,9-s*0.08);
    var hue=(s*14+(Date.now()/40)%360)%360;
    ctx.fillStyle='hsl('+hue+' 90% 55%)';
    ctx.beginPath(); ctx.arc(p.x,p.y,r,0,Math.PI*2); ctx.fill();
  }
}

/* ===== CAT ‚Äî –∫–∞–º–µ—Ä–∞ –≤–≤–µ—Ä—Ö + —Å–∏–ª—å–Ω—ã–π –ø—Ä—ã–∂–æ–∫ ===== */
var CAT_G=1400, CAT_JUMP=-760, CAT_BOUNCE=-800, CAT_SPEED=240, CAT_GAP_MIN=140, CAT_GAP_MAX=170;
var cat=null, tramps=[], camY=0, jumpRequest=false, airJump=true, minCamY=0;

function startCat(){
  setScore(0); jumpRequest=false; airJump=true;
  var W=canvas.clientWidth, H=canvas.clientHeight;
  cat={x:W/2,y:H*0.6,vx:0,vy:0,onGround:false};
  camY = cat.y - H*0.35;           // —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–∞–¥—Ä
  minCamY = camY;                  // –∫–∞–º–µ—Ä–∞ –º–æ–∂–µ—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –≤–≤–µ—Ä—Ö (–≤ –º–µ–Ω—å—à—É—é Y)
  tramps=[]; 
  for (var i=0;i<14;i++) addTramp(i===0? (cat.y+40) : null); // –ø–µ—Ä–≤–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø–æ–¥ –∫–æ—Ç–æ–º
}

function addTramp(constY){
  var W=canvas.clientWidth;
  var gap = CAT_GAP_MIN + Math.random()*(CAT_GAP_MAX-CAT_GAP_MIN);
  var newY = (typeof constY==='number') ? constY : (tramps.length ? tramps[tramps.length-1].y - gap : camY + 200);
  var x = 60 + Math.random()*(W-120);
  tramps.push({x:x, y:newY, w:Math.max(120, Math.min(220, W*0.3)), h:18});
}

/* –ø—Ä—ã–∂–æ–∫ ‚Äî —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ cat (—á—Ç–æ–±—ã –º–µ–Ω—é –Ω–µ –ª–æ–º–∞—Ç—å) */
function requestJump(){ if (state==='cat') jumpRequest = true; }
['pointerdown','mousedown'].forEach(function(evt){
  canvas.addEventListener(evt, function(){ if(state==='cat'){ requestJump(); } }, {passive:false});
});
['touchstart'].forEach(function(evt){
  canvas.addEventListener(evt, function(e){ if(state==='cat'){ e.preventDefault(); requestJump(); } }, {passive:false});
});
jumpBtn.addEventListener('pointerdown', function(e){ e.preventDefault(); requestJump(); }, {passive:false});
jumpBtn.addEventListener('touchstart',  function(e){ e.preventDefault(); requestJump(); }, {passive:false});

function updateCat(dt){
  var W=canvas.clientWidth, H=canvas.clientHeight;

  // —Ö–æ–¥—å–±–∞
  var move = joyRight.ax; cat.vx = move * CAT_SPEED;

  // —Ñ–∏–∑–∏–∫–∞
  cat.vy += CAT_G * dt;
  cat.x  += cat.vx * dt;
  cat.y  += cat.vy * dt;
  cat.x = Math.max(16, Math.min(W-16, cat.x));

  // –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (–ø—Ä–∏–∑–µ–º–ª–µ–Ω–∏–µ)
  cat.onGround=false;
  for (var i=0;i<tramps.length;i++){
    var t=tramps[i];
    if (cat.vy>0 && cat.y+12>=t.y && cat.y+12<=t.y+t.h+3 && cat.x>t.x && cat.x<t.x+t.w){
      cat.y=t.y-12; cat.vy=CAT_BOUNCE; cat.onGround=true; airJump=true; setScore(score+1);
    }
  }

  // –ø—Ä—ã–∂–æ–∫
  if (jumpRequest){
    if (cat.onGround || airJump){
      cat.vy = CAT_JUMP;
      if (!cat.onGround) airJump=false;
    }
    jumpRequest=false;
  }

  // –ö–ê–ú–ï–†–ê: —Ü–µ–ª–µ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è ‚Äî –¥–µ—Ä–∂–∞—Ç—å –∫–æ—Ç–∞ –Ω–∞ 35% –æ—Ç –≤–µ—Ä—Ö–∞
  var desired = cat.y - H*0.35;
  if (desired < minCamY) minCamY = desired;           // –∑–∞–ø–æ–º–∏–Ω–∞–µ–º —Å–∞–º—ã–π –≤–µ—Ä—Ö
  // —Å–≥–ª–∞–∂–µ–Ω–Ω–æ —Ç—è–Ω–µ–º –∫–∞–º–µ—Ä—É —Ç–æ–ª—å–∫–æ –≤–≤–µ—Ä—Ö
  if (minCamY < camY){
    camY += (minCamY - camY) * Math.min(1, dt*6);     // lerp
    if (Math.abs(minCamY - camY) < 0.5) camY = minCamY;
  }

  // –°–ü–ê–í–ù: –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –≤—ã—à–µ —ç–∫—Ä–∞–Ω–∞
  var topY = tramps.length ? tramps[0].y : camY + 200;
  for (i=1;i<tramps.length;i++) if (tramps[i].y < topY) topY = tramps[i].y;
  while (topY > camY - H*0.8 && tramps.length < 60){    // –¥–æ–∫–ª–∞–¥—ã–≤–∞–µ–º –≤–≤–µ—Ä—Ö
    addTramp(topY - (CAT_GAP_MIN + Math.random()*(CAT_GAP_MAX-CAT_GAP_MIN)));
    // –æ–±–Ω–æ–≤–∏–º topY
    topY = tramps[0].y; for (i=1;i<tramps.length;i++) if (tramps[i].y < topY) topY = tramps[i].y;
  }

  // –û—á–∏—Å—Ç–∫–∞: –≤—Å—ë, —á—Ç–æ —Å–∏–ª—å–Ω–æ –Ω–∏–∂–µ –Ω–∏–∑–∞ —ç–∫—Ä–∞–Ω–∞ ‚Äî –≤ —É—Ç–∏–ª—å
  for (i=tramps.length-1;i>=0;i--){
    if (tramps[i].y > camY + H + 200){ tramps.splice(i,1); }
  }

  // —Ñ–µ–π–ª: —É–ø–∞–ª —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–æ
  if (cat.y > camY + H + 240){ showMenu(); }
}

function drawCat(){
  var W=canvas.clientWidth,H=canvas.clientHeight;
  ctx.fillStyle='#0a0e19'; ctx.fillRect(0,0,W,H);
  // –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —Å —É—á—ë—Ç–æ–º –∫–∞–º–µ—Ä—ã
  ctx.fillStyle='#80ffd8'; ctx.strokeStyle='rgba(0,0,0,.25)'; ctx.lineWidth=1;
  for (var i=0;i<tramps.length;i++){
    var t=tramps[i]; roundRect(t.x, t.y - camY, t.w, t.h, 10); ctx.fill(); ctx.stroke();
  }
  // –∫–æ—Ç
  drawCatSprite(cat.x, cat.y - camY);
}

/* –£—Ç–∏–ª–∏—Ç—ã */
function roundRect(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
function drawCatSprite(x,y){
  ctx.save(); ctx.translate(x,y);
  ctx.fillStyle='rgba(0,0,0,.25)'; ctx.beginPath(); ctx.ellipse(0,16,14,6,0,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#f59e0b'; roundRect(-12,-6,24,26,8); ctx.fill();
  ctx.beginPath(); ctx.fillStyle='#fca5a5'; ctx.arc(0,-16,11,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.moveTo(-8,-20); ctx.lineTo(-3,-28); ctx.lineTo(2,-20); ctx.closePath(); ctx.fill();
  ctx.beginPath(); ctx.moveTo(8,-20);  ctx.lineTo(3,-28);  ctx.lineTo(-2,-20); ctx.closePath(); ctx.fill();
  ctx.fillStyle='#111'; ctx.beginPath(); ctx.arc(-3.5,-17,2,0,Math.PI*2); ctx.arc(3.5,-17,2,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.strokeStyle='rgba(173,216,230,.9)'; ctx.lineWidth=3; ctx.arc(0,-16,14,0,Math.PI*2); ctx.stroke();
  ctx.restore();
}

/* –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª */
var last = Date.now(), paused=false;
function loop(){
  var now = Date.now();
  var dt = Math.min(33, now-last)/1000; last = now;
  if (!paused){
    if (state==='worm'){ updateWorm(dt); drawWorm(); }
    else if (state==='cat'){ updateCat(dt); drawCat(); }
    else { ctx.fillStyle='#0a0e19'; ctx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight); }
  }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
document.addEventListener('visibilitychange', function(){ paused=document.hidden; });

/* —Å—Ç–∞—Ä—Ç */
showMenu();
</script>
</body>
</html>