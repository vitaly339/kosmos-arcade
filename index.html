<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Cosmo Arcade ‚Äî Worm (boosts, fruits, bomb, ads, records)</title>
<style>
  html,body{margin:0;height:100%;background:#0a1020;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;-webkit-user-select:none;user-select:none;touch-action:none}
  #wrap{display:flex;flex-direction:column;height:100dvh}
  header{padding:8px 12px;background:#121a36;border-bottom:1px solid #22325a;display:flex;gap:8px;align-items:center}
  header h1{font-size:16px;margin:0}
  #ui{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .hbtn{padding:6px 10px;background:#182a56;border:1px solid #3a5aa0;border-radius:8px;color:#fff;font-weight:700;cursor:pointer}
  #score{padding:6px 10px;background:#0f1a36;border:1px solid #2b3f6f;border-radius:8px;font-weight:700;min-width:64px;text-align:center}

  #stage{position:relative;flex:1;min-height:0}
  #canvas{position:absolute;inset:0;display:block;width:100%;height:100%;touch-action:none;background:#070c18;z-index:1}

  /* –û–≤–µ—Ä–ª–µ–∏ */
  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(8,12,24,.85);z-index:20}
  .card{background:#0f1730;border:1px solid #2b3f6f;border-radius:12px;padding:16px;max-width:560px;width:92%}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .btn{display:inline-block;padding:12px 14px;background:#182a56;border:1px solid #3a5aa0;border-radius:10px;color:#fff;font-weight:700;cursor:pointer}
  .field{display:flex;gap:8px;align-items:center;margin:6px 0}
  input[type="text"]{background:#0f1a36;color:#fff;border:1px solid #2b3f6f;border-radius:8px;padding:8px 10px;min-width:160px}

  /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–¥–∂–æ–π—Å—Ç–∏–∫ + –∫–Ω–æ–ø–∫–∏) */
  #touch{position:absolute;left:10px;right:10px;bottom:10px;display:flex;justify-content:space-between;gap:10px;z-index:5}
  .joy{position:relative;display:block;width:120px;height:120px;border-radius:50%;background:#0b1430cc;border:1px solid #2b3e68}
  .knob{position:absolute;left:50%;top:50%;width:56px;height:56px;border-radius:50%;background:#172a58;border:1px solid #3b5ca0;transform:translate(-50%,-50%)}

  /* –ö–Ω–æ–ø–∫–∏ Worm */
  #boostBtn,#invisBtn{position:absolute;left:140px;bottom:20px;display:inline-block;z-index:6}
  #boostBtn{background:#0e8a6a;border-color:#33c49f}
  #invisBtn{left:260px;background:#8a0e6a;border-color:#d658b1}

  /* –í–∏–¥–µ–æ-—Ä–µ–∫–ª–∞–º–∞ */
  #adWrap{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.75);z-index:30}
  #adCard{background:#0b1024;border:1px solid #2b3f6f;border-radius:12px;padding:10px;max-width:80%;width:560px}
  #adVideo{width:100%;max-height:70dvh;background:#000;border-radius:8px}
  #skipAd{margin-top:8px;width:100%}

  /* –ü–æ–¥–ø–∏—Å—å */
  #footer{position:absolute;left:0;right:0;bottom:2px;text-align:center;font-size:12px;opacity:.8;z-index:2;pointer-events:none}
</style>
</head>
<body>
<div id="wrap">
  <header>
    <h1>Cosmo Arcade</h1>
    <div class="field" style="margin-left:10px">
      <label for="playerName" style="font-size:12px;opacity:.85">–ò–º—è:</label>
      <input id="playerName" type="text" placeholder="–≤–∞—à–µ –∏–º—è" maxlength="16">
      <button id="saveName" class="hbtn">OK</button>
    </div>
    <div id="ui">
      <div id="score">0</div>
      <button id="shopBtn" class="hbtn">–ú–∞–≥–∞–∑–∏–Ω</button>
      <button id="recordsBtn" class="hbtn">–†–µ–∫–æ—Ä–¥—ã</button>
      <button id="restart" class="hbtn">–†–µ—Å—Ç–∞—Ä—Ç</button>
    </div>
  </header>

  <div id="stage">
    <canvas id="canvas"></canvas>

    <!-- –ú–µ–Ω—é -->
    <div id="menu" class="overlay" style="display:flex">
      <div class="card">
        <h3 style="margin:0 0 8px 0">Worm ‚Äî —Å—Ç–∞—Ä—Ç</h3>
        <p style="opacity:.9;margin-top:0">–õ–µ–≤—ã–π –¥–∂–æ–π—Å—Ç–∏–∫ ‚Äî –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ. –ö–Ω–æ–ø–∫–∏: Boost –∏ –ù–µ–≤–∏–¥–∏–º–∫–∞.</p>
        <div class="row">
          <button class="btn" id="playWorm">üêç –ò–≥—Ä–∞—Ç—å</button>
          <button class="btn" id="openShop">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
          <button class="btn" id="openRec">üèÜ –†–µ–∫–æ—Ä–¥—ã</button>
        </div>
        <div class="field" style="margin-top:10px">
          <button id="preInvis" class="btn">–í–∫–ª—é—á–∏—Ç—å ¬´–ù–µ–≤–∏–¥–∏–º–∫–∞¬ª –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º</button>
        </div>
        <p style="opacity:.7;font-size:12px;margin-top:8px">–§–∞–π–ª <code>ad.mp4</code> –≤ –∫–æ—Ä–Ω–µ –ø–æ–∫–∞–∂–µ—Ç—Å—è –ø–æ—Å–ª–µ ¬´–≤–∑—Ä—ã–≤–∞¬ª –±–æ–º–±—ã, –∑–∞—Ç–µ–º –∏–≥—Ä–∞ –Ω–∞—á–Ω—ë—Ç—Å—è –∑–∞–Ω–æ–≤–æ.</p>
      </div>
    </div>

    <!-- –ú–∞–≥–∞–∑–∏–Ω -->
    <div id="shop" class="overlay">
      <div class="card">
        <h3 style="margin:0 0 8px 0">–ú–∞–≥–∞–∑–∏–Ω –±—É—Å—Ç–æ–≤</h3>
        <p id="bank" style="margin:4px 0 10px 0">–ë–∞–ª–∞–Ω—Å: 0 –æ—á–∫–æ–≤</p>
        <div class="row">
          <button class="btn" id="buyInvis">–ö—É–ø–∏—Ç—å ¬´–ù–µ–≤–∏–¥–∏–º–∫–∞¬ª (200)</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="shopClose">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <p style="opacity:.75;font-size:12px;margin-top:8px">¬´–ù–µ–≤–∏–¥–∏–º–∫–∞¬ª: –ø—Ä–æ—Ö–æ–¥ —á–µ—Ä–µ–∑ –±–æ–º–±—ã –∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è ~10 —Å–µ–∫.</p>
      </div>
    </div>

    <!-- –†–µ–∫–æ—Ä–¥—ã -->
    <div id="records" class="overlay">
      <div class="card">
        <h3 style="margin:0 0 8px 0">–¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤</h3>
        <div id="recAll" style="font-family:monospace;white-space:pre"></div>
        <h4 style="margin:10px 0 4px 0">–í–∞—à–∏ –ª—É—á—à–∏–µ</h4>
        <div id="recMine" style="font-family:monospace;white-space:pre"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="recClose">–ó–∞–∫—Ä—ã—Ç—å</button>
          <button class="btn" id="recReset">–°–±—Ä–æ—Å–∏—Ç—å —Ä–µ–∫–æ—Ä–¥—ã</button>
        </div>
      </div>
    </div>

    <!-- –í–∏–¥–µ–æ-—Ä–µ–∫–ª–∞–º–∞ –ø—Ä–∏ –±–æ–º–±–µ -->
    <div id="adWrap" class="overlay">
      <div id="adCard">
        <video id="adVideo" playsinline muted autoplay controls></video>
        <button class="btn" id="skipAd">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
      </div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
    <div id="touch">
      <div class="joy" id="joyLeft"><div class="knob"></div></div>
      <button id="boostBtn" class="btn">Boost</button>
      <button id="invisBtn" class="btn">–ù–µ–≤–∏–¥–∏–º–∫–∞</button>
    </div>

    <div id="footer">made by kosmos.bud 2k25</div>
  </div>
</div>

<script>
/* ====== SIMPLE STORAGE ====== */
var LS = {
  get: function(k, d){ try{ var v = localStorage.getItem(k); return v? JSON.parse(v): d; }catch(e){ return d; } },
  set: function(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
};
var playerName = LS.get('playerName','Player');
var bank = LS.get('bank',0);          // –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –æ—á–∫–∏
var invCount = LS.get('invCount',0);  // –∫—É–ø–ª–µ–Ω–Ω—ã–µ ¬´–Ω–µ–≤–∏–¥–∏–º–∫–∏¬ª

/* ====== DOM ====== */
var canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
var menu = document.getElementById('menu'), shop = document.getElementById('shop'), records = document.getElementById('records');
var scoreEl = document.getElementById('score');
var joyLeftEl = document.getElementById('joyLeft');
var boostBtn = document.getElementById('boostBtn'), invisBtn = document.getElementById('invisBtn');
var nameInput = document.getElementById('playerName'), saveNameBtn = document.getElementById('saveName');
var bankEl = document.getElementById('bank'), buyInvisBtn = document.getElementById('buyInvis');
var openShopBtn = document.getElementById('openShop'), shopBtnTop = document.getElementById('shopBtn'), shopClose = document.getElementById('shopClose');
var openRecBtn = document.getElementById('openRec'), recBtnTop = document.getElementById('recordsBtn'), recClose = document.getElementById('recClose'), recReset = document.getElementById('recReset');
var recAll = document.getElementById('recAll'), recMine = document.getElementById('recMine');
var adWrap = document.getElementById('adWrap'), adVideo = document.getElementById('adVideo'), skipAd = document.getElementById('skipAd');
var restartBtn = document.getElementById('restart');
var preInvisBtn = document.getElementById('preInvis');
nameInput.value = playerName;

/* ====== CANVAS SIZE ====== */
function resize(){
  var r = Math.max(1, Math.min(window.devicePixelRatio || 1, 3));
  var w = canvas.parentElement.clientWidth, h = canvas.parentElement.clientHeight;
  canvas.style.width = w+'px'; canvas.style.height = h+'px';
  canvas.width = Math.floor(w*r); canvas.height = Math.floor(h*r);
  ctx.setTransform(r,0,0,r,0,0);
}
addEventListener('resize', resize); resize();

/* ====== STATE ====== */
var score=0, state='menu';
function setScore(v){ score=v|0; scoreEl.textContent=score; }
function showMenu(){ state='menu'; menu.style.display='flex'; }
function hideMenu(){ menu.style.display='none'; }
document.getElementById('playWorm').onclick = function(){ startWorm(); hideMenu(); };
restartBtn.onclick = function(){ startWorm(); };

/* ====== SHOP & RECORDS ====== */
function updateBankUI(){ bankEl.textContent = '–ë–∞–ª–∞–Ω—Å: '+bank+' –æ—á–∫–æ–≤'; }
function openShop(){ updateBankUI(); shop.style.display='flex'; }
function closeShop(){ shop.style.display='none'; }
openShopBtn.addEventListener('click', openShop);
shopBtnTop.addEventListener('click', openShop);
shopClose.addEventListener('click', closeShop);

buyInvisBtn.addEventListener('click', function(){
  if (bank>=200){ bank-=200; invCount++; LS.set('bank',bank); LS.set('invCount',invCount); updateBankUI(); alert('–ù–µ–≤–∏–¥–∏–º–∫–∞ –∫—É–ø–ª–µ–Ω–∞. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º (–∫–Ω–æ–ø–∫–∞ –≤ –º–µ–Ω—é) –∏–ª–∏ –≤ –∏–≥—Ä–µ.'); }
  else alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤.');
});

function fmtTable(arr){
  var out=''; for (var i=0;i<arr.length;i++){ var r=arr[i]; out+=(i+1)+'. '+(r.name||'Player')+'  ‚Äî  '+r.score+'\n'; }
  return out||'(–ø—É—Å—Ç–æ)';
}
function updateRecordsUI(){
  var all = LS.get('records',[]); all.sort(function(a,b){ return b.score-a.score; });
  recAll.textContent = fmtTable(all.slice(0,10));
  var mine = all.filter(function(r){ return r.name===playerName; }).sort(function(a,b){ return b.score-a.score; });
  recMine.textContent = fmtTable(mine.slice(0,10));
}
function openRecords(){ updateRecordsUI(); records.style.display='flex'; }
function closeRecords(){ records.style.display='none'; }
openRecBtn.addEventListener('click', openRecords);
recBtnTop.addEventListener('click', openRecords);
recClose.addEventListener('click', closeRecords);
recReset.addEventListener('click', function(){ if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ä–µ–∫–æ—Ä–¥—ã?')){ LS.set('records',[]); updateRecordsUI(); }});

saveNameBtn.addEventListener('click', function(){
  playerName = (nameInput.value||'Player').slice(0,16);
  LS.set('playerName', playerName);
  updateRecordsUI();
});

/* ====== JOYSTICK ====== */
function makeJoystick(root, radius){
  var knob = root.querySelector('.knob');
  var st = {ax:0, ay:0, active:false};
  var rect=null, id=null;
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function setKnob(ax,ay){
    knob.style.left = (50 + clamp(ax,-1,1)*50) + '%';
    knob.style.top  = (50 + clamp(ay,-1,1)*50) + '%';
    knob.style.transform = 'translate(-50%,-50%)';
  }
  function reset(){ st.ax=0; st.ay=0; st.active=false; setKnob(0,0); }
  function startXY(x,y,pid){ id=pid; rect=root.getBoundingClientRect(); st.active=true;
    var cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
    st.ax = clamp((x-cx)/radius,-1,1); st.ay = clamp((y-cy)/radius,-1,1); setKnob(st.ax,st.ay);
  }
  function moveXY(x,y){ if(!st.active) return; var cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
    st.ax = clamp((x-cx)/radius,-1,1); st.ay = clamp((y-cy)/radius,-1,1); setKnob(st.ax,st.ay);
  }
  function endXY(){ reset(); }
  root.addEventListener('pointerdown', function(e){ e.preventDefault(); if(root.setPointerCapture) root.setPointerCapture(e.pointerId); startXY(e.clientX,e.clientY,e.pointerId); }, {passive:false});
  root.addEventListener('pointermove',  function(e){ if(e.pointerId!==id) return; moveXY(e.clientX,e.clientY); });
  root.addEventListener('pointerup',    function(e){ if(e.pointerId!==id) return; endXY(); });
  root.addEventListener('pointercancel',function(){ endXY(); });

  root.addEventListener('touchstart', function(e){ e.preventDefault(); var t=e.changedTouches[0]; startXY(t.clientX,t.clientY,'t'); }, {passive:false});
  root.addEventListener('touchmove',  function(e){ e.preventDefault(); var t=e.changedTouches[0]; moveXY(t.clientX,t.clientY); }, {passive:false});
  root.addEventListener('touchend',   function(e){ e.preventDefault(); endXY(); }, {passive:false});

  setKnob(0,0); return st;
}
var joyLeft = makeJoystick(joyLeftEl, 50);

/* ====== WORM GAME ====== */
var worm=null, foods=[], bombs=[];
var boostHold=false, boostMul=1.6;
var invis=false, invisTimer=0;
var preInvis=false;

var FRUITS = [
  {color:'#ff6b6b', score:5},  // ¬´—è–±–ª–æ–∫–æ¬ª
  {color:'#ffd166', score:7},  // ¬´–±–∞–Ω–∞–Ω¬ª
  {color:'#c084fc', score:9},  // ¬´–≤–∏–Ω–æ–≥—Ä–∞–¥¬ª
  {color:'#7dd3fc', score:12}  // ¬´–∑–≤–µ–∑–¥–∞¬ª
];

document.getElementById('openShop').onclick = openShop;
document.getElementById('openRec').onclick = openRecords;
document.getElementById('shopBtn').onclick = openShop;
document.getElementById('recordsBtn').onclick = openRecords;
preInvisBtn.onclick = function(){
  if (invCount>0){ preInvis = !preInvis; alert('–ù–µ–≤–∏–¥–∏–º–∫–∞ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º: '+(preInvis?'–í–ö–õ':'–í–´–ö–õ')); }
  else alert('–£ –≤–∞—Å –Ω–µ—Ç –∫—É–ø–ª–µ–Ω–Ω–æ–π ¬´–ù–µ–≤–∏–¥–∏–º–∫–∏¬ª. –ö—É–ø–∏—Ç–µ –≤ –º–∞–≥–∞–∑–∏–Ω–µ.');
};

function startWorm(){
  state='worm';
  setScore(0);
  foods=[]; bombs=[];
  var W=canvas.clientWidth,H=canvas.clientHeight;
  worm={x:W*0.5,y:H*0.5, ang:-Math.PI/2, spd:Math.min(W,H)*0.19, trail:[], segs:16, step:4, alive:true};
  var nf = Math.round((W*H)/9000);
  for (var i=0;i<nf;i++){ spawnFruit(); }
  var nb = Math.max(2, Math.round((W*H)/60000));
  for (i=0;i<nb;i++){ spawnBomb(); }

  // –∞–≤—Ç–æ-–∞–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–µ–≤–∏–¥–∏–º–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ, –µ—Å–ª–∏ –≤–∫–ª—é—á–∏–ª–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ
  if (preInvis && invCount>0){ invCount--; LS.set('invCount',invCount); invis=true; invisTimer=10; }
}

function spawnFruit(){
  var W=canvas.clientWidth,H=canvas.clientHeight;
  var f = FRUITS[Math.floor(Math.random()*FRUITS.length)];
  foods.push({x:Math.random()*W, y:Math.random()*H, r:3.5, color:f.color, score:f.score});
}
function spawnBomb(){
  var W=canvas.clientWidth,H=canvas.clientHeight;
  bombs.push({x:Math.random()*W, y:Math.random()*H, r:8});
}

function updateWorm(dt){
  var W=canvas.clientWidth,H=canvas.clientHeight;

  // —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ + —Å–∫–æ—Ä–æ—Å—Ç—å
  if (joyLeft.active){ worm.ang=Math.atan2(joyLeft.ay, joyLeft.ax); }
  var spd = worm.spd * (boostHold?boostMul:1);
  worm.x += Math.cos(worm.ang)*spd*dt;
  worm.y += Math.sin(worm.ang)*spd*dt;
  wrap(worm,W,H);
  worm.trail.unshift({x:worm.x,y:worm.y}); if (worm.trail.length>1600) worm.trail.pop();

  // —Ñ—Ä—É–∫—Ç—ã
  for (var i=foods.length-1;i>=0;i--){
    var f=foods[i];
    if (dist(worm.x,worm.y,f.x,f.y) < 12){
      foods.splice(i,1); setScore(score+f.score); bank += f.score; spawnFruit();
    }
  }

  // –±–æ–º–±—ã
  for (i=bombs.length-1;i>=0;i--){
    var b=bombs[i];
    if (!invis && dist(worm.x,worm.y,b.x,b.y) < 12){
      bombs.splice(i,1);
      triggerAdAndRestart(); // –≤–∑—Ä—ã–≤ ‚Üí –≤–∏–¥–µ–æ ‚Üí —Ä–µ—Å—Ç–∞—Ä—Ç
      break;
    }
  }

  // —Ç–∞–π–º–µ—Ä –Ω–µ–≤–∏–¥–∏–º–∫–∏
  if (invis){ invisTimer -= dt; if (invisTimer<=0){ invis=false; } }
}

function drawWorm(){
  var W=canvas.clientWidth,H=canvas.clientHeight;
  ctx.fillStyle='#071122'; ctx.fillRect(0,0,W,H);

  // —Ñ—Ä—É–∫—Ç—ã (—Ä–∞–∑–Ω—ã–µ —Ü–≤–µ—Ç–∞ = —Ä–∞–∑–Ω—ã–µ –æ—á–∫–∏)
  for (var i=0;i<foods.length;i++){
    var f=foods[i]; ctx.fillStyle=f.color; ctx.beginPath(); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); ctx.fill();
  }

  // –±–æ–º–±—ã
  for (i=0;i<bombs.length;i++){
    var b=bombs[i]; ctx.fillStyle='#111'; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#ff5252'; ctx.beginPath(); ctx.arc(b.x,b.y,3,0,Math.PI*2); ctx.fill();
  }

  // –∑–º–µ–π–∫–∞ (—Ä–∞–¥—É–∂–Ω–∞—è)
  for (var s=0;s<worm.segs;s++){
    var p = worm.trail[s*worm.step] || worm;
    var r = Math.max(3.2, 9.5 - s*0.08);
    var hue = (s*14 + (Date.now()/40)%360) % 360;
    ctx.fillStyle = 'hsl('+hue+' 90% 55%)';
    ctx.beginPath(); ctx.arc(p.x,p.y,r,0,Math.PI*2); ctx.fill();
  }

  // –∏–º—è –∏–≥—Ä–æ–∫–∞ –Ω–∞–¥ –≥–æ–ª–æ–≤–æ–π
  ctx.fillStyle='rgba(255,255,255,.9)'; ctx.font='12px system-ui'; ctx.textAlign='center';
  ctx.fillText(playerName, worm.x, worm.y - 16);

  // —Å—Ç–∞—Ç—É—Å –±—É—Å—Ç–æ–≤
  ctx.fillStyle='rgba(255,255,255,.8)'; ctx.font='12px system-ui'; ctx.textAlign='left';
  if (boostHold) ctx.fillText('BOOST', 12, 16);
  if (invis)     ctx.fillText('INVIS '+Math.ceil(invisTimer)+'s', 12, 32);
}

function wrap(o,W,H){ if (o.x<0) o.x+=W; if (o.x>W) o.x-=W; if (o.y<0) o.y+=H; if (o.y>H) o.y-=H; }
function dist(ax,ay,bx,by){ var dx=ax-bx, dy=ay-by; return Math.sqrt(dx*dx+dy*dy); }

/* Boost –∏ –ù–µ–≤–∏–¥–∏–º–∫–∞ */
boostBtn.addEventListener('pointerdown', function(e){ e.preventDefault(); if(state==='worm') boostHold=true; }, {passive:false});
boostBtn.addEventListener('pointerup',   function(){ boostHold=false; });
boostBtn.addEventListener('pointercancel',function(){ boostHold=false; });
boostBtn.addEventListener('touchstart', function(e){ e.preventDefault(); if(state==='worm') boostHold=true; }, {passive:false});
boostBtn.addEventListener('touchend',   function(){ boostHold=false; }, {passive:false});

invisBtn.addEventListener('click', function(){
  if (state!=='worm') return;
  if (!invis){
    if (invCount>0){ invCount--; LS.set('invCount',invCount); invis=true; invisTimer=10; }
    else if (bank>=200){ if (confirm('–ö—É–ø–∏—Ç—å ¬´–ù–µ–≤–∏–¥–∏–º–∫–∞¬ª –∑–∞ 200 –æ—á–∫–æ–≤ –∏ —Å—Ä–∞–∑—É –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å?')){ bank-=200; LS.set('bank',bank); invis=true; invisTimer=10; } }
    else { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤. –°–æ–±–µ—Ä–∏—Ç–µ —Ñ—Ä—É–∫—Ç—ã –∏–ª–∏ –∫—É–ø–∏—Ç–µ –≤ –º–∞–≥–∞–∑–∏–Ω–µ.'); }
  }
});

/* –ë–æ–º–±–∞ ‚Üí –≤–∏–¥–µ–æ (ad.mp4) ‚Üí —Ä–µ—Å—Ç–∞—Ä—Ç —É—Ä–æ–≤–Ω—è */
function triggerAdAndRestart(){
  saveRecord(playerName, score);   // –∑–∞–ø–∏—à–µ–º —Ä–µ–∫–æ—Ä–¥
  LS.set('bank', bank);            // —Å–æ—Ö—Ä–∞–Ω–∏–º –±–∞–Ω–∫

  adVideo.src = 'ad.mp4';          // –ø–æ–ª–æ–∂–∏ —Ñ–∞–π–ª —Ä—è–¥–æ–º —Å index.html
  adWrap.style.display='flex';
  var ended = function(){ finishAd(); };
  var skip = function(){ finishAd(); };
  function finishAd(){
    adVideo.pause(); adWrap.style.display='none';
    adVideo.removeEventListener('ended', ended);
    skipAd.removeEventListener('click', skip);
    startWorm();                   // —Ä–µ—Å—Ç–∞—Ä—Ç –∏–≥—Ä—ã
  }
  adVideo.addEventListener('ended', ended);
  skipAd.addEventListener('click', skip);
}

/* –†–µ–∫–æ—Ä–¥—ã */
function saveRecord(name, sc){
  var arr = LS.get('records',[]);
  arr.push({name:name||'Player', score:sc|0, ts:Date.now()});
  LS.set('records', arr);
}

/* ====== MAIN LOOP ====== */
var last = Date.now(), paused=false;
function loop(){
  var now=Date.now(), dt=Math.min(33, now-last)/1000; last=now;
  if (!paused){
    if (state==='worm'){ updateWorm(dt); drawWorm(); }
    else { ctx.fillStyle='#070c18'; ctx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight); }
  }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
document.addEventListener('visibilitychange', function(){ paused=document.hidden; });

/* ====== START ====== */
function init(){
  updateBankUI();
  // —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –º–µ–Ω—é
  showMenu();
}
init();
</script>
</body>
</html>