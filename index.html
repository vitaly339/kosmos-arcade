<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="theme-color" content="#071126" />
<title>Cosmo Arcade ‚Äî Touch Update (joysticks per mode)</title>
<style>
  :root { --bg:#070b17; --panel:#0f1730; --line:#1e2a4a; --btn:#1a2b54; --btn-b:#365aa2; }
  html,body{margin:0;height:100%;background:var(--bg);color:#fff;font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial}
  #wrap{display:flex;flex-direction:column;height:100dvh}

  header{padding:8px 12px;background:var(--panel);
    border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px;
    box-shadow:0 4px 20px rgba(0,0,0,.35)}
  header h1{font-size:16px;margin:0;opacity:.95;letter-spacing:.2px}
  #ui{margin-left:auto;display:flex;gap:6px;align-items:center}
  #score{padding:6px 10px;background:#132044;border:1px solid #2a3f6f;border-radius:8px;font-weight:700;box-shadow:inset 0 0 12px rgba(100,160,255,.2)}
  #boosts{opacity:.9;font-size:12px;max-width:40ch;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  #stage{position:relative;flex:1;min-height:0}
  #canvas{position:absolute;inset:0;display:block;width:100%;height:100%;touch-action:none;
    background: radial-gradient(1200px 800px at 50% 110%, #0d1a3a, #0a1126 55%, #070b17);}

  #menu{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(5,8,14,.86);backdrop-filter:blur(2px)}
  .card{background:#0f1630d9;border:1px solid #2b3f6f;border-radius:14px;padding:18px;max-width:540px;width:92%;
    box-shadow:0 12px 36px rgba(0,0,0,.5)}
  .card h2{margin:0 0 10px 0}
  .btn{display:block;width:100%;padding:14px 16px;margin:8px 0;background:var(--btn);border:1px solid var(--btn-b);border-radius:12px;color:#fff;font-weight:700;text-align:center;text-decoration:none;cursor:pointer}
  .row{display:flex;gap:8px}
  .btn.small{flex:1;padding:10px}
  .field{display:flex;gap:8px;align-items:center;margin-top:8px}
  .field label{opacity:.85;font-size:13px}
  select{background:#0f1a36;color:#fff;border:1px solid #2b3f6f;border-radius:8px;padding:8px}

  /* –î–∂–æ–π—Å—Ç–∏–∫–∏ ‚Äî –ø–æ –æ–¥–Ω–æ–º—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–∂–∏–º–∞, —Å–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑ JS */
  #touch{position:absolute;left:10px;right:10px;bottom:10px;display:flex;justify-content:space-between;gap:10px;pointer-events:none}
  .joy{pointer-events:auto;position:relative;display:none;width:120px;height:120px;border-radius:50%;
       background:#0b1430cc;border:1px solid #2b3e68;box-shadow:0 0 18px rgba(100,170,255,.18) inset}
  .joy.small{width:100px;height:100px}
  .knob{position:absolute;left:50%;top:50%;width:56px;height:56px;border-radius:50%;
        background:#172a58;border:1px solid #3b5ca0;transform:translate(-50%,-50%);box-shadow:0 0 10px rgba(90,150,255,.35)}
  .joy.small .knob{width:48px;height:48px}

  #hint{position:absolute;right:10px;bottom:10px;background:#0e1628cc;border:1px solid #2b3e68;border-radius:10px;padding:8px 10px;font-size:12px}
</style>
</head>
<body>
<div id="wrap">
  <header>
    <h1>Cosmo Arcade</h1>
    <div id="ui">
      <div id="score">0</div>
      <div id="boosts"></div>
      <button id="back" class="btn small" style="width:auto;padding:6px 10px;margin:0 0 0 8px">–í –º–µ–Ω—é</button>
    </div>
  </header>

  <div id="stage">
    <canvas id="canvas"></canvas>

    <div id="menu">
      <div class="card">
        <h2>–í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º</h2>
        <button class="btn" data-mode="worm">üêç Worm Arena</button>
        <div class="field">
          <label for="wormColor">–¶–≤–µ—Ç —á–µ—Ä–≤—è—á–∫–∞:</label>
          <select id="wormColor">
            <option value="rainbow">üåà –†–∞–¥—É–∂–Ω—ã–π</option>
            <option value="red">üî¥ –ö—Ä–∞—Å–Ω—ã–π</option>
            <option value="green">üü¢ –ó–µ–ª—ë–Ω—ã–π</option>
            <option value="blue">üîµ –°–∏–Ω–∏–π</option>
            <option value="purple">üü£ –§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option>
          </select>
        </div>
        <button class="btn" data-mode="cat" style="margin-top:6px">üê± Trampoline Cat</button>
        <div class="row" style="margin-top:6px">
          <div class="btn small" id="help">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
        </div>
        <p style="opacity:.85;font-size:12px;margin:8px 0 0 0">
          –û–±–Ω–æ–≤–ª–µ–Ω–∏—è: –¥–∂–æ–π—Å—Ç–∏–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Å–≤–æ—ë–º —Ä–µ–∂–∏–º–µ; —É –∫–æ—Ç–∞ ‚Äî –ø—Ä—ã–∂–æ–∫ –ø–æ —Ç–∞–ø—É –≤ –ª—é–±–æ–π —Ç–æ—á–∫–µ.
        </p>
      </div>
    </div>

    <!-- –õ–µ–≤—ã–π ‚Äî –¥–ª—è Worm; –ü—Ä–∞–≤—ã–π ‚Äî –¥–ª—è Cat -->
    <div id="touch">
      <div class="joy" id="joyLeft"><div class="knob"></div></div>
      <div class="joy small" id="joyRight"><div class="knob"></div></div>
    </div>

    <div id="hint"></div>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { alpha: false, desynchronized: true });
  const menu = document.getElementById('menu');
  const scoreEl = document.getElementById('score');
  const boostsEl = document.getElementById('boosts');
  const backBtn = document.getElementById('back');
  const hint = document.getElementById('hint');
  const selWormColor = document.getElementById('wormColor');

  // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª/–∑—É–º –Ω–∞–¥ –∏–≥—Ä–æ–π
  ['touchstart','touchmove','gesturestart'].forEach(evt=>{
    document.addEventListener(evt, e => {
      if (e.target.closest('#canvas') || e.target.closest('.joy')) e.preventDefault();
    }, { passive: false });
  });

  function resize() {
    const r = Math.max(1, Math.min(window.devicePixelRatio || 1, 3));
    const w = canvas.clientWidth = canvas.parentElement.clientWidth;
    const h = canvas.clientHeight = canvas.parentElement.clientHeight;
    canvas.width = Math.floor(w * r);
    canvas.height = Math.floor(h * r);
    ctx.setTransform(r, 0, 0, r, 0, 0);
  }
  window.addEventListener('resize', resize);
  resize();

  // HUD/–±—É—Å—Ç—ã
  let score = 0;
  const boosts = {};
  const hasBoost = k => (boosts[k]||0) > 0;
  const addBoost = (k, secs) => { boosts[k]=(boosts[k]||0)+secs; updateHud(); };
  const scoreMul = () => hasBoost('x2') ? 2 : 1;
  function updateHud(){
    scoreEl.textContent = Math.round(score);
    const list = Object.entries(boosts).map(([k,v])=> `${k}:${v.toFixed(0)}s`).join('  ');
    boostsEl.textContent = list;
  }
  function tickBoosts(dt){
    let changed=false;
    for(const k in boosts){ boosts[k]-=dt; if(boosts[k]<=0){ delete boosts[k]; changed=true; } }
    if (changed) updateHud();
  }
  function resetHud(){ score=0; for (const k in boosts) delete boosts[k]; updateHud(); }

  // –ú–µ–Ω—é/—Ä–µ–∂–∏–º—ã + –ø–æ–∫–∞–∑ –¥–∂–æ–π—Å—Ç–∏–∫–æ–≤ –ø–æ —Ä–µ–∂–∏–º–∞–º
  let state = 'menu';
  const joyLeftEl = document.getElementById('joyLeft');
  const joyRightEl = document.getElementById('joyRight');
  function showJoysticksFor(mode){
    joyLeftEl.style.display  = (mode==='worm') ? 'block' : 'none';
    joyRightEl.style.display = (mode==='cat')  ? 'block' : 'none';
  }
  function showMenu(){ state='menu'; menu.style.display='flex'; showJoysticksFor('none'); }
  function hideMenu(){ menu.style.display='none'; }
  document.querySelectorAll('[data-mode]').forEach(btn=>{
    btn.onclick = () => {
      if (btn.dataset.mode === 'worm'){ startWorm(); state='worm'; showJoysticksFor('worm'); }
      else { startCat(); state='cat'; showJoysticksFor('cat'); }
      hideMenu();
    };
  });
  backBtn.onclick = showMenu;
  document.getElementById('help').onclick = () => {
    hint.textContent = 'Worm: –ª–µ–≤—ã–π –¥–∂–æ–π—Å—Ç–∏–∫ –∫—Ä—É—Ç–∏—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ. Cat: –ø—Ä–∞–≤—ã–π –¥–∂–æ–π—Å—Ç–∏–∫ ‚Äî —Ö–æ–¥—å–±–∞, —Ç–∞–ø –≤ –ª—é–±–æ–π —Ç–æ—á–∫–µ ‚Äî –ø—Ä—ã–∂–æ–∫.';
    setTimeout(()=> hint.textContent='', 4200);
  };

  // === –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –¥–∂–æ–π—Å—Ç–∏–∫ (—Ñ–∏–∫—Å—ã –æ—Å–µ–π –∏ —Ç—è–≥–∏)
  function makeJoystick(root, radiusPx=50){
    const knob = root.querySelector('.knob');
    const st = {ax:0, ay:0, active:false};
    let rect=null, id=null, startT=0, startPos=null;
    const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
    function setKnob(ax, ay){
      knob.style.left = (50 + clamp(ax,-1,1)*50) + '%';
      knob.style.top  = (50 + clamp(ay,-1,1)*50) + '%';
      knob.style.transform = 'translate(-50%,-50%)';
    }
    function reset(){ st.ax=0; st.ay=0; st.active=false; setKnob(0,0); }
    root.addEventListener('pointerdown', e=>{
      e.preventDefault(); id=e.pointerId; rect=root.getBoundingClientRect(); root.setPointerCapture?.(id);
      st.active=true; startT=performance.now(); startPos={x:e.clientX,y:e.clientY};
      const cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
      st.ax = clamp((e.clientX-cx)/radiusPx,-1,1);
      st.ay = clamp((e.clientY-cy)/radiusPx,-1,1);
      setKnob(st.ax, st.ay);
      // –í —Ä–µ–∂–∏–º–µ Cat: —Ç–∞–ø –¥–∞–∂–µ –ø–æ –¥–∂–æ–π—Å—Ç–∏–∫—É —Ç–æ–∂–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –ø—Ä—ã–∂–æ–∫
      if (state==='cat') triggerCatTapJump();
    }, {passive:false});
    root.addEventListener('pointermove', e=>{
      if (!st.active || e.pointerId!==id) return;
      const cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
      st.ax = clamp((e.clientX-cx)/radiusPx,-1,1);
      st.ay = clamp((e.clientY-cy)/radiusPx,-1,1);
      setKnob(st.ax, st.ay);
    });
    const end = (e)=>{
      if (e.pointerId!==id) return; reset();
    };
    root.addEventListener('pointerup', end);
    root.addEventListener('pointercancel', end);
    root.addEventListener('pointerleave', end);
    setKnob(0,0);
    return st;
  }
  const joyLeft  = makeJoystick(joyLeftEl, 50);
  const joyRight = makeJoystick(joyRightEl, 40);

  // ==== WORM (–ª–µ–≤—ã–π –¥–∂–æ–π—Å—Ç–∏–∫ —É–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º)
  let worm, foods=[], stars=[];
  let wormColorMode = 'rainbow';
  selWormColor.addEventListener('change', ()=> wormColorMode = selWormColor.value);

  function startWorm(){
    resetHud();
    wormColorMode = selWormColor.value;
    const W = canvas.clientWidth, H = canvas.clientHeight;
    worm = { x:W/2, y:H/2, angle:-Math.PI/2, speed: Math.min(W,H)*0.19, trail:[], segments:16, step:4 };
    foods = []; stars = [];
    const foodCount = Math.round((W*H)/8500);
    for(let i=0;i<foodCount;i++) foods.push({x:Math.random()*W, y:Math.random()*H});
    for(let i=0;i<4;i++) stars.push({x:Math.random()*W, y:Math.random()*H, type:['speed','magnet','x2','shield'][i%4]});
  }

  function updateWorm(dt){
    if (joyLeft.active){
      worm.angle = Math.atan2(joyLeft.ay, joyLeft.ax);
    }
    const spd = worm.speed * (hasBoost('speed')?1.5:1);
    worm.x += Math.cos(worm.angle)*spd*dt;
    worm.y += Math.sin(worm.angle)*spd*dt;

    const W = canvas.clientWidth, H = canvas.clientHeight;
    if (worm.x<0) worm.x+=W; if (worm.x>W) worm.x-=W;
    if (worm.y<0) worm.y+=H; if (worm.y>H) worm.y-=H;

    worm.trail.unshift({x:worm.x,y:worm.y});
    if (worm.trail.length > 1600) worm.trail.pop();

    if (hasBoost('magnet')){
      for (const f of foods){
        const dx = worm.x - f.x, dy = worm.y - f.y, d = Math.hypot(dx,dy);
        if (d < 150){ f.x += dx/d * 110*dt; f.y += dy/d * 110*dt; }
      }
    }
    for (let i=foods.length-1;i>=0;i--){
      const f = foods[i];
      if (Math.hypot(f.x-worm.x, f.y-worm.y) < 12){
        foods.splice(i,1);
        score += 5 * scoreMul(); updateHud();
        worm.segments = Math.min(100, worm.segments+1);
        foods.push({x:Math.random()*W, y:Math.random()*H});
      }
    }
    for (let i=stars.length-1;i>=0;i--){
      const b = stars[i];
      if (Math.hypot(b.x-worm.x, b.y-worm.y) < 16){
        stars.splice(i,1);
        addBoost(b.type==='x2'?'x2':b.type, 8);
        setTimeout(()=> stars.push({x:Math.random()*W, y:Math.random()*H, type:['speed','magnet','x2','shield'][Math.floor(Math.random()*4)]}), 1500);
      }
    }
  }

  // –†–∞–¥—É–∂–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞
  function hsl(h,s,l){
    s/=100; l/=100;
    const k = n => (n + h/30) % 12;
    const a = s * Math.min(l,1-l);
    const f = n => l - a * Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1)));
    return `rgb(${Math.round(255*f(0))},${Math.round(255*f(8))},${Math.round(255*f(4))})`;
  }

  function drawWorm(){
    const W = canvas.clientWidth, H = canvas.clientHeight;
    drawSpaceBackdrop();
    // –µ–¥–∞/–±—É—Å—Ç—ã
    ctx.fillStyle='#7ad3ff';
    foods.forEach(f=>{ ctx.shadowColor='#61d2ff'; ctx.shadowBlur=8; ctx.beginPath(); ctx.arc(f.x,f.y,3.5,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0; });
    stars.forEach(b=> drawStar(b.x,b.y,9,b.type));
    // —Ç–µ–ª–æ
    for(let s=0;s<worm.segments;s++){
      const idx = s*worm.step; const p = worm.trail[idx] || worm;
      const r = Math.max(3.2, 9.5 - s*0.08);
      let color = '#f9a825';
      if (wormColorMode==='rainbow'){
        const hue = (s*14 + (performance.now()/40)%360) % 360;
        color = hsl(hue, 90, 55);
      } else if (wormColorMode==='red') color='#ff5b5b';
      else if (wormColorMode==='green') color='#7eed6b';
      else if (wormColorMode==='blue') color='#64b5ff';
      else if (wormColorMode==='purple') color='#c084fc';
      if (s===0 && wormColorMode!=='rainbow') color = '#ffd166';
      ctx.beginPath(); ctx.fillStyle = color; ctx.shadowColor=color; ctx.shadowBlur = s<6 ? 14 : 0;
      ctx.arc(p.x,p.y,r,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0;
    }
  }

  // ==== CAT (–ø—Ä–∞–≤—ã–π –¥–∂–æ–π—Å—Ç–∏–∫ —Ö–æ–¥—å–±–∞, —Ç–∞–ø ‚Äî –ø—Ä—ã–∂–æ–∫ –≤ –ª—é–±–æ–π —Ç–æ—á–∫–µ)
  let cat, tramps=[], camY=0, maxY=0, catStars=[], jumpLatch=false;
  let catJumpTapTimer = 0;

  function startCat(){
    resetHud();
    const W = canvas.clientWidth;
    cat = { x:W/2, y:220, vx:0, vy:0, onGround:false };
    tramps = []; catStars = []; camY=0; maxY=0; jumpLatch=false; catJumpTapTimer=0;
    for(let i=0;i<14;i++) addTramp(i===0 ? 260 : null);
    for(let i=0;i<3;i++) spawnCatBoost(Math.random()*600+240);
  }
  function addTramp(constY=null){
    const W = canvas.clientWidth;
    const gapY = 90 + Math.random()*90;
    const newY = constY!==null ? constY : (tramps.length ? tramps[tramps.length-1].y - gapY : 260);
    const x = 60 + Math.random()*(W-120);
    tramps.push({x, y:newY, w:Math.max(110, Math.min(200, W*0.28)), h:18, bouncy: 14+Math.random()*4});
  }
  function spawnCatBoost(y){
    const W = canvas.clientWidth;
    catStars.push({x: 60+Math.random()*(W-120), y: y-(Math.random()*220), r:10, type: ['speed','magnet','x2'][Math.floor(Math.random()*3)]});
  }

  // –¢–∞–ø –≤ –õ–Æ–ë–û–ô —Ç–æ—á–∫–µ —ç–∫—Ä–∞–Ω–∞ ‚Üí –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä—ã–∂–æ–∫ (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ Cat)
  function triggerCatTapJump(){ if (state==='cat') catJumpTapTimer = 0.12; }
  window.addEventListener('pointerdown', (e)=>{ if (state==='cat') triggerCatTapJump(); }, {passive:false});

  function updateCat(dt){
    const W = canvas.clientWidth, H = canvas.clientHeight;

    // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å –∏–∑ –ø—Ä–∞–≤–æ–≥–æ –¥–∂–æ–π—Å—Ç–∏–∫–∞ (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –∫–æ–≥–¥–∞ –Ω–µ active ‚Äî –Ω–æ–ª—å)
    const move = joyRight.ax; // -1..1
    const moveSpeed = hasBoost('speed') ? 250 : 190;
    cat.vx = move * moveSpeed;

    // –§–∏–∑–∏–∫–∞
    cat.vy += 540*dt;
    cat.x += cat.vx*dt;
    cat.y += cat.vy*dt;
    cat.x = Math.max(16, Math.min(W-16, cat.x));

    // –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã
    cat.onGround = false;
    for (const t of tramps){
      if (cat.vy > 0 && cat.y+10 >= t.y && cat.y+10 <= t.y+t.h && cat.x > t.x && cat.x < t.x+t.w){
        cat.y = t.y-10; cat.vy = -t.bouncy; cat.onGround = true; score += 1*scoreMul(); updateHud();
      }
    }

    // –ü—Ä—ã–∂–æ–∫: –ø–æ —Ç–∞–ø—É (—Ç–∞–π–º–µ—Ä) + –∞–Ω—Ç–∏–∑–∞–ª–∏–ø–∞–Ω–∏–µ
    if (catJumpTapTimer > 0) catJumpTapTimer -= dt;
    const wantJump = catJumpTapTimer > 0;
    if (wantJump && cat.onGround && !jumpLatch){
      jumpLatch = true;
      cat.vy = -(hasBoost('speed') ? 18 : 15);
      catJumpTapTimer = 0;
    }
    if (!wantJump) jumpLatch = false;

    // –ö–∞–º–µ—Ä–∞ / —Å–ø–∞–≤–Ω
    if (cat.y < maxY) maxY = cat.y;
    camY = Math.min(0, -maxY + H*0.3);
    const highest = tramps.reduce((m,t)=> Math.min(m,t.y), tramps[0]?.y||0);
    while (highest - camY > -H*1.3 && tramps.length < 38) addTramp();
    for (let i=tramps.length-1;i>=0;i--){
      if (tramps[i].y - camY > H+120){
        tramps.splice(i,1);
        addTramp(tramps.reduce((m,t)=>Math.min(m,t.y),9999) - (90+Math.random()*90));
        spawnCatBoost(tramps.reduce((m,t)=>Math.min(m,t.y),9999) - 120);
      }
    }

    // –ë—É—Å—Ç—ã
    for (let i=catStars.length-1;i>=0;i--){
      const b = catStars[i];
      let dx = b.x - cat.x, dy = (b.y - camY) - cat.y;
      if (hasBoost('magnet')){
        const d = Math.hypot(dx,dy); if (d < 160){ b.x -= dx/d * 140*dt; b.y -= dy/d * 140*dt; }
      }
      if (Math.hypot(dx,dy) < 16){ catStars.splice(i,1); addBoost(b.type, 8); }
    }

    if (cat.y - camY > H + 120){ showMenu(); }
  }

  function drawCat(){
    const W = canvas.clientWidth, H = canvas.clientHeight;
    drawSpaceBackdrop(camY);
    // –±—É—Å—Ç—ã
    catStars.forEach(b => drawStar(b.x, b.y - camY, 10, b.type));
    // –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    ctx.fillStyle='#80ffd8'; ctx.strokeStyle='rgba(0,0,0,.22)'; ctx.lineWidth=1;
    tramps.forEach(t=>{ roundRect(t.x, t.y - camY, t.w, t.h, 10); ctx.shadowColor='#80ffd8'; ctx.shadowBlur=8; ctx.fill(); ctx.shadowBlur=0; ctx.stroke(); });
    // –∫–æ—Ç
    drawCatAstronaut(cat.x, cat.y - camY);
  }

  // ==== –†–µ–Ω–¥–µ—Ä-—É—Ç–∏–ª–∏—Ç—ã –∏ —Ñ–æ–Ω
  function drawSpaceBackdrop(offsetY=0){
    const W = canvas.clientWidth, H = canvas.clientHeight;
    // –º—è–≥–∫–∏–π –∑–≤—ë–∑–¥–Ω—ã–π —à—É–º
    ctx.fillStyle='rgba(255,255,255,.03)';
    for(let i=0;i<160;i++){
      const x=(i*97)%W, y=((i*53)%H) + (offsetY*.2 % H);
      ctx.fillRect(x,y,2,2);
    }
    // –ª—ë–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ –ø–æ –∫—Ä–∞—è–º
    const grad = ctx.createRadialGradient(W*0.5, H*0.66, 50, W*0.5, H*0.66, Math.max(W,H)*0.9);
    grad.addColorStop(0,'rgba(40,100,255,.06)');
    grad.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=grad; ctx.fillRect(0,0,W,H);
  }

  function drawStar(x,y,r,type){
    ctx.save(); ctx.translate(x,y); ctx.rotate(performance.now()/800);
    ctx.beginPath();
    for(let i=0;i<10;i++){ const ang=i*Math.PI/5; const rr=(i%2===0? r : r*0.45); ctx.lineTo(Math.cos(ang)*rr, Math.sin(ang)*rr); }
    ctx.closePath();
    ctx.fillStyle = type==='speed'?'#ffd166': type==='magnet'?'#7dd3fc': type==='shield'?'#a5b4fc':'#f9a8d4';
    ctx.shadowColor = ctx.fillStyle; ctx.shadowBlur = 10;
    ctx.fill(); ctx.shadowBlur = 0; ctx.restore();
  }
  function roundRect(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }

  // –ö–æ—Ç ‚Äî –±–æ–ª–µ–µ ¬´–∫–æ—Ç–∏–∫¬ª :)
  function drawCatAstronaut(x,y){
    ctx.save(); ctx.translate(x,y);

    // —Ç–µ–Ω—å
    ctx.fillStyle='rgba(0,0,0,.25)'; ctx.beginPath(); ctx.ellipse(0,16,14,6,0,0,Math.PI*2); ctx.fill();

    // —Ö–≤–æ—Å—Ç
    ctx.strokeStyle='#f5a623'; ctx.lineWidth=6; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(-10,6); ctx.quadraticCurveTo(-26,2,-20,-8); ctx.stroke();

    // —Ç–µ–ª–æ (—Å–∫–∞—Ñ–∞–Ω–¥—Ä)
    ctx.fillStyle = '#f59e0b';
    roundRect(-12,-6,24,26,8); ctx.fill();
    // –ø–æ–ª–æ—Å–∫–∏ –Ω–∞ —Ä—É–∫–∞—Ö
    ctx.strokeStyle='#ffdf8a'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(-10,2); ctx.lineTo(-2,2); ctx.moveTo(2,2); ctx.lineTo(10,2); ctx.stroke();

    // —Ä—é–∫–∑–∞–∫
    ctx.fillStyle='#1e2a4a'; roundRect(-16,-4,6,20,3); ctx.fill();

    // –≥–æ–ª–æ–≤–∞
    ctx.beginPath(); ctx.fillStyle='#fca5a5'; ctx.arc(0,-16,11,0,Math.PI*2); ctx.fill();

    // —É—à–∫–∏
    ctx.beginPath(); ctx.moveTo(-8,-20); ctx.lineTo(-3,-28); ctx.lineTo(2,-20); ctx.closePath(); ctx.fill();
    ctx.beginPath(); ctx.moveTo(8,-20); ctx.lineTo(3,-28); ctx.lineTo(-2,-20); ctx.closePath(); ctx.fill();

    // –≥–ª–∞–∑–∞ –∏ –Ω–æ—Å
    ctx.fillStyle='#111'; ctx.beginPath(); ctx.arc(-3.5,-17,2,0,Math.PI*2); ctx.arc(3.5,-17,2,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#f87171'; ctx.beginPath(); ctx.moveTo(0,-14); ctx.lineTo(2,-12); ctx.lineTo(-2,-12); ctx.closePath(); ctx.fill();

    // —É—Å—ã
    ctx.strokeStyle='rgba(0,0,0,.6)'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.moveTo(-2,-14); ctx.lineTo(-10,-13);
    ctx.moveTo(-2,-16); ctx.lineTo(-10,-16.5);
    ctx.moveTo(2,-14);  ctx.lineTo(10,-13);
    ctx.moveTo(2,-16);  ctx.lineTo(10,-16.5); ctx.stroke();

    // —à–ª–µ–º —Å—Ç–µ–∫–ª–æ
    ctx.beginPath(); ctx.strokeStyle='rgba(173,216,230,.9)'; ctx.lineWidth=3; ctx.arc(0,-16,14,0,Math.PI*2); ctx.stroke();
    // –±–ª–∏–∫
    ctx.beginPath(); ctx.strokeStyle='rgba(200,240,255,.35)'; ctx.lineWidth=2; ctx.arc(-5,-20,8,0,Math.PI*1.2); ctx.stroke();

    ctx.restore();
  }

  // –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª
  let last = performance.now(), paused = false;
  function loop(now){
    const dt = Math.min(0.033, (now - last)/1000); last = now;
    if (!paused){
      if (state === 'worm'){ updateWorm(dt); tickBoosts(dt); drawWorm(); }
      else if (state === 'cat'){ updateCat(dt); tickBoosts(dt); drawCat(); }
      else { drawSpaceBackdrop(); }
    }
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
  document.addEventListener('visibilitychange', ()=> paused = document.hidden);

  // –°—Ç–∞—Ä—Ç
  showMenu();
})();
</script>
</body>
</html>